<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Account Details - Damascus Master</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" 
  href="favicon.svg">
  <link rel="stylesheet" href="theme.css">
  <style>
  /* Compact layout adjustments */
  body.compact .account-container { max-width: 38rem; padding: 1rem; }
  body.compact .account-section { padding: 0.6rem; margin-bottom: 0.6rem; }
  body.compact .tab-btn { padding: 0.4rem 0.8rem; }
  body.compact .btn { padding: 0.6rem 1rem; font-size: 0.95rem; }
  /* More compact rules */
  body.compact header { padding: 0.6rem 1rem; }
  body.compact .account-title { font-size: 1.6rem; margin-bottom: 1rem; }
  body.compact .account-container { max-width: 46rem; }
  body.compact .input-group { gap: 0.5rem; }
  body.compact .account-section input, body.compact .account-section textarea { padding: 0.5rem 0.7rem; font-size: 0.95rem; }
  body.compact .settings-tabs { gap: 0.6rem; }
  body.compact .stats-grid { gap: 0.6rem; }
    body {
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFFDD0; /* cream */
      padding: 1.2rem 2.5rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
      border-bottom: 1px solid #e7dfc6;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      height: 3.125rem;
      margin-right: 0.625rem;
    }
    .logo h1 {
      color: var(--primary);
      font-size: 2.1rem;
      font-family: 'Montserrat', Arial, sans-serif;
      letter-spacing: 0.18rem;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.18);
      margin: 0;
    }
    .account-container {
      max-width: 48rem;
      margin: 3rem auto 2rem auto;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2rem 2rem 2rem;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    .account-title {
      color: var(--primary);
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .settings-tabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid rgba(212, 175, 55, 0.2);
      padding-bottom: 1rem;
    }
    .tab-btn {
      background: none;
      border: 2px solid var(--primary);
      color: var(--primary);
      padding: 0.7rem 1.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .tab-btn.active {
      background: var(--primary);
      color: #1A1612;
    }
    .tab-btn:hover {
      background: var(--primary-dark);
      color: #1A1612;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .account-section {
      margin-bottom: 1.5rem;
      background: rgba(26, 22, 18, 0.3);
      padding: 1.2rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(212, 175, 55, 0.1);
    }
    .section-title {
      color: var(--primary);
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .account-section label {
      display: block;
      color: var(--text);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .account-section input, .account-section textarea, .account-section select {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(212, 175, 55, 0.3);
      background: var(--input-bg); /* use theme input background for consistency */
      color: var(--text-primary); /* ensure readable text */
      font-size: 1rem;
      margin-bottom: 0.8rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    .account-section input:focus, .account-section textarea:focus, .account-section select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    .account-section input[readonly] {
      background: rgba(26, 22, 18, 0.08);
      color: var(--text-muted);
      font-style: italic;
    }

    /* Local placeholder styles for account page to ensure visibility */
    .account-section input::placeholder,
    .account-section textarea::placeholder,
    .account-section select::placeholder {
      color: var(--text-secondary);
      opacity: 0.95;
      font-size: 0.95rem;
    }

    /* Password placeholders slightly smaller */
    .account-section .password-container input::placeholder {
      color: var(--text-secondary);
      opacity: 0.95;
      font-size: 0.9rem;
    }
    .input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .account-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 2rem;
    }
    .btn {
      background: var(--primary);
      color: #1A1612;
      border: none;
      border-radius: 0.5rem;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    .btn-secondary {
      background: var(--card-bg) !important;
      color: var(--accent-gold) !important;
      border: 2px solid var(--accent-gold) !important;
      padding: 0.7rem 1.2rem !important;
      border-radius: 0.5rem !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      display: inline-block !important;
    }
    .btn-secondary:hover {
      background: var(--accent-gold) !important;
      color: var(--button-text) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3) !important;
    }
    .btn-danger {
      background: #DC3545;
      color: white;
      border: 2px solid #DC3545;
    }
    .btn-danger:hover {
      background: #C82333;
      border-color: #C82333;
    }
    .logo-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .current-logo {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      object-fit: cover;
    }
    .preference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(26, 22, 18, 0.3);
      border-radius: 0.5rem;
      margin-bottom: 0.8rem;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #2D251E;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .toggle-switch.active {
      background: var(--primary);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .toggle-switch.active::after {
      transform: translateX(26px);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .stat-card {
      background: rgba(26, 22, 18, 0.5);
      padding: 1.2rem;
      border-radius: 0.8rem;
      text-align: center;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    /* Achievements Styles */
    .achievement-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      margin-bottom: 0.8rem;
      background: rgba(26, 22, 18, 0.5);
      border-radius: 0.8rem;
      border: 1px solid rgba(212, 175, 55, 0.2);
      transition: all 0.3s ease;
    }
    
    .achievement-item.unlocked {
      border-color: var(--primary);
      background: rgba(212, 175, 55, 0.1);
    }
    
    .achievement-item.locked {
      opacity: 0.6;
      border-color: #444;
    }
    
    .achievement-icon {
      font-size: 1.5rem;
      margin-right: 1rem;
    }
    
    .achievement-info {
      flex: 1;
    }
    
    .achievement-title {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    
    .achievement-desc {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin: 0;
    }
    
    .achievement-status {
      font-size: 1.5rem;
    }
    
    /* Progress Bars */
    .progress-item {
      margin-bottom: 1.5rem;
    }
    
    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: 500;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(26, 22, 18, 0.5);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* Password Toggle Styles */
    .password-container {
      position: relative;
    }
    
    .password-container input {
      padding-right: 2.8rem; /* leave room for right-side eye */
    }
    
    .password-toggle {
      position: absolute;
      right: 0.6rem; /* place on right inside input */
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #b0b8c1;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
  /* remove decorative dots for password placeholders to match login styling */
    
  /* no hover color change for a clean professional look */
    
    
    @media (max-width: 768px) {
      .account-container {
        margin: 1rem;
        padding: 1.5rem 1rem;
      }
      .settings-tabs {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .tab-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .input-group {
        grid-template-columns: 1fr;
      }
      .account-actions {
        flex-direction: column;
      }
      header {
        padding: 1rem 0.7rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="logo.png" alt="Damascus Master Logo">
      <h1>Damascus Master</h1>
    </div>
  </header>
  <main>
    <div class="account-container">
      <div class="account-title">‚öôÔ∏è Account Settings</div>
      
      <!-- Settings Tabs -->
      <div class="settings-tabs">
        <button class="tab-btn active" data-tab="profile">üë§ Profile</button>
        <button class="tab-btn" data-tab="security">üîí Security</button>
        <button class="tab-btn" data-tab="preferences">üé® Preferences</button>
        <button class="tab-btn" data-tab="orders">üì¶ Orders</button>
        <button class="tab-btn" data-tab="achievements">üèÜ Achievements</button>
        <button class="tab-btn" data-tab="stats">üìä Statistics</button>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content active" id="profile">
        <div class="account-section">
          <div class="section-title">üë§ Personal Information</div>
          <div class="logo-selector">
            <div id="account-logo-wrap">
              <img src="" alt="Profile" class="current-logo" id="current-logo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
            </div>
            <button class="btn-secondary" id="change-logo-btn" onclick="(function(){ try { showLogoPicker(); } catch(e) { var inp=document.getElementById('custom-avatar-upload'); if (inp) inp.click(); } })();">Change Avatar</button>
            <input type="file" id="custom-avatar-upload" accept="image/*"  class="u-hidden">
          </div>
          <div class="input-group">
            <div>
              <label for="account-name">Full Name</label>
              <input type="text" id="account-name" placeholder="Enter your full name" autocomplete="name">
            </div>
            <div>
              <label for="account-username">Username</label>
              <input type="text" id="account-username" placeholder="Enter username" autocomplete="username">
            </div>
          </div>
          <div>
            <label for="account-email">Email Address</label>
            <input type="email" id="account-email" readonly autocomplete="email">
          </div>
          <div>
            <label for="account-phone">Phone Number</label>
            <input type="tel" id="account-phone" placeholder="Enter phone number" autocomplete="tel">
          </div>
        </div>

        <div class="account-section">
          <div class="section-title">üè† Address Information</div>
          <div>
            <label for="account-address">Street Address</label>
            <input type="text" id="account-address" placeholder="Enter street address" autocomplete="street-address">
          </div>
          <div class="input-group">
            <div>
              <label for="account-city">City</label>
              <input type="text" id="account-city" placeholder="Enter city" autocomplete="address-level2">
            </div>
            <div>
              <label for="account-state">State/Province</label>
              <input type="text" id="account-state" placeholder="Enter state" autocomplete="address-level1">
            </div>
          </div>
          <div class="input-group">
            <div>
              <label for="account-zip">ZIP/Postal Code</label>
              <input type="text" id="account-zip" placeholder="Enter ZIP code" autocomplete="postal-code">
            </div>
            <div>
              <label for="account-country">Country</label>
              <select id="account-country" autocomplete="country">
                <option value="">Select Country</option>
                <!-- North America -->
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <!-- Europe -->
                <option value="UK">United Kingdom</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="IT">Italy</option>
                <option value="ES">Spain</option>
                <option value="NL">Netherlands</option>
                <option value="CH">Switzerland</option>
                <option value="AT">Austria</option>
                <option value="BE">Belgium</option>
                <option value="SE">Sweden</option>
                <option value="NO">Norway</option>
                <option value="DK">Denmark</option>
                <option value="FI">Finland</option>
                <option value="IE">Ireland</option>
                <option value="LU">Luxembourg</option>
                <option value="PT">Portugal</option>
                <option value="GR">Greece</option>
                <option value="CZ">Czech Republic</option>
                <option value="PL">Poland</option>
                <option value="HU">Hungary</option>
                <option value="SK">Slovakia</option>
                <option value="SI">Slovenia</option>
                <option value="EE">Estonia</option>
                <option value="LV">Latvia</option>
                <option value="LT">Lithuania</option>
                <option value="MT">Malta</option>
                <option value="CY">Cyprus</option>
                <!-- Asia-Pacific -->
                <option value="JP">Japan</option>
                <option value="AU">Australia</option>
                <option value="NZ">New Zealand</option>
                <option value="SG">Singapore</option>
                <option value="HK">Hong Kong</option>
                <option value="KR">South Korea</option>
                <option value="TW">Taiwan</option>
                <option value="MY">Malaysia</option>
                <option value="TH">Thailand</option>
                <option value="BN">Brunei</option>
                <!-- Middle East -->
                <option value="AE">United Arab Emirates</option>
                <option value="SA">Saudi Arabia</option>
                <option value="QA">Qatar</option>
                <option value="KW">Kuwait</option>
                <option value="BH">Bahrain</option>
                <option value="OM">Oman</option>
                <option value="IL">Israel</option>
                <option value="TR">Turkey</option>
                <!-- Americas -->
                <option value="MX">Mexico</option>
                <option value="BR">Brazil</option>
                <option value="AR">Argentina</option>
                <option value="CL">Chile</option>
                <option value="UY">Uruguay</option>
                <option value="CR">Costa Rica</option>
                <option value="PA">Panama</option>
                <!-- Africa -->
                <option value="ZA">South Africa</option>
                <option value="EG">Egypt</option>
                <option value="MA">Morocco</option>
                <option value="TN">Tunisia</option>
                <!-- Other -->
                <option value="RU">Russia</option>
                <option value="CN">China</option>
                <option value="IN">India</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Tab -->
      <div class="tab-content" id="security">
        <div class="account-section">
          <div class="section-title">üîí Password & Security</div>
          <div>
            <label for="current-password">Current Password</label>
            <div class="password-container">
              <input type="password" id="current-password" placeholder="Current Password" autocomplete="current-password">
              <button type="button" class="password-toggle" onclick="toggleAccountPassword('current-password')" tabindex="-1" aria-label="Show password">
                <span id="eye-current-password" style="pointer-events:none; font-size:1.1em;">&#128065;</span>
              </button>
            </div>
          </div>
          <div>
            <label for="new-password">New Password</label>
            <div class="password-container">
              <input type="password" id="new-password" placeholder="New Password" autocomplete="new-password">
              <button type="button" class="password-toggle" onclick="toggleAccountPassword('new-password')" tabindex="-1" aria-label="Show password">
                <span id="eye-new-password" style="pointer-events:none; font-size:1.1em;">&#128065;</span>
              </button>
            </div>
          </div>
          <div>
            <label for="confirm-password">Confirm New Password</label>
            <div class="password-container">
              <input type="password" id="confirm-password" placeholder="Confirm New Password" autocomplete="new-password">
              <button type="button" class="password-toggle" onclick="toggleAccountPassword('confirm-password')" tabindex="-1" aria-label="Show password">
                <span id="eye-confirm-password" style="pointer-events:none; font-size:1.1em;">&#128065;</span>
              </button>
            </div>
          </div>
          <button class="btn-secondary" onclick="changePassword()">Update Password</button>
        </div>

        <div class="account-section">
          <div class="section-title">üõ°Ô∏è Account Security</div>
          <div class="preference-item">
            <div>
              <strong>Two-Factor Authentication</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Add extra security to your account</p>
            </div>
            <div class="toggle-switch" data-setting="2fa"></div>
          </div>
          <div class="preference-item">
            <div>
              <strong>Login Email Notifications</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Get notified of new logins</p>
            </div>
            <div class="toggle-switch" data-setting="login-notifications"></div>
          </div>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div class="tab-content" id="preferences">
        <div class="account-section">
          <div class="section-title">üé® Display Preferences</div>
          <!-- Dark Mode removed: default is light theme -->
          <div class="preference-item">
            <div>
              <strong>Compact Layout</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Show more content in less space</p>
            </div>
            <div class="toggle-switch" data-setting="compact-layout"></div>
          </div>
        </div>

        <div class="account-section">
          <div class="section-title">üìß Email Preferences</div>
          <div class="preference-item">
            <div>
              <strong>Order Updates</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Receive order status updates</p>
            </div>
            <div class="toggle-switch active" data-setting="order-emails"></div>
          </div>
          <div class="preference-item">
            <div>
              <strong>Marketing Emails</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Get news about new products</p>
            </div>
            <div class="toggle-switch" data-setting="marketing-emails"></div>
          </div>
          <div class="preference-item">
            <div>
              <strong>Weekly Newsletter</strong>
              <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Damascus steel tips and stories</p>
            </div>
            <div class="toggle-switch" data-setting="newsletter"></div>
          </div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div class="tab-content" id="orders">
        <div class="account-section">
          <div class="section-title">üì¶ Order History</div>
          <div id="order-history">
            <p style="text-align:center;color:var(--text-muted);padding:2rem;">No orders found. <a href="index.html" style="color:var(--primary);">Start shopping!</a></p>
          </div>
        </div>

        <div class="account-section">
          <div class="section-title">üíù Wishlist Items</div>
          <div id="wishlist-items">
            <p style="text-align:center;color:var(--text-muted);padding:2rem;">Your wishlist is empty.</p>
          </div>
        </div>
      </div>

      <!-- Achievements Tab -->
      <div class="tab-content" id="achievements">
        <div class="account-section">
          <div class="section-title">üèÜ Account Achievements</div>
          <div id="achievements-list">
            <!-- Achievements will be loaded dynamically -->
          </div>
        </div>
        
        <div class="account-section">
          <div class="section-title">üéØ Progress Tracking</div>
          <div class="progress-container">
            <div class="progress-item">
              <div class="progress-label">
                <span>üõí Orders Completed</span>
                <span id="orders-progress">0/10</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="orders-progress-fill" style="width: 0%;"></div>
              </div>
            </div>
            
            <div class="progress-item">
              <div class="progress-label">
                <span>üí∞ Total Spending</span>
                <span id="spending-progress">$0/$500</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="spending-progress-fill" style="width: 0%;"></div>
              </div>
            </div>
            
            <div class="progress-item">
              <div class="progress-label">
                <span>‚ù§Ô∏è Wishlist Items</span>
                <span id="wishlist-progress">0/10</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="wishlist-progress-fill" style="width: 0%;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div class="tab-content" id="stats">
        <div class="account-section">
          <div class="section-title">üìä Account Statistics</div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="total-orders">0</div>
              <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="total-spent">$0</div>
              <div class="stat-label">Total Spent</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="wishlist-count">0</div>
              <div class="stat-label">Wishlist Items</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="member-since">2024</div>
              <div class="stat-label">Member Since</div>
            </div>
          </div>
        </div>

        <div class="account-section">
          <div class="section-title">üèÜ Account Achievements</div>
          <div id="achievements">
            <div class="preference-item">
              <div>
                <strong>üî• First Purchase</strong>
                <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Made your first order</p>
              </div>
              <span style="color:var(--primary);">‚úÖ</span>
            </div>
            <div class="preference-item">
              <div>
                <strong>üíé Premium Collector</strong>
                <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">Spent over $500</p>
              </div>
              <span style="color:var(--text-muted);">üîí</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="account-actions">
        <button class="btn" onclick="saveAccountSettings()">üíæ Save Changes</button>
        <button class="btn-secondary" onclick="goHome()">üè† Back to Shop</button>
  <button class="btn-danger" onclick="logout()">üö™ Logout</button>
  <button class="btn-danger" style="background:#7c1b1b;border-color:#7c1b1b;" onclick="showDeleteAccountModal()">üóëÔ∏è Delete Account</button>
      </div>
    </div>
  </main>
  <script>
  // Backend API Configuration
  const SERVER_URL = (location.origin && location.origin !== 'null' && location.protocol && location.protocol.startsWith('http')) ? location.origin : 'http://localhost:3025';
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    // Authentication Check
    async function checkAuth() {
      if (!authToken) {
        alert('Please log in first.');
        window.location.href = 'login.html';
        return false;
      }

      try {
        const response = await fetch(`${SERVER_URL}/api/auth/profile`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          return true;
        } else {
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
          alert('Session expired. Please log in again.');
          window.location.href = 'login.html';
          return false;
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        try { alert(`Unable to verify authentication. Please log in again. Tried: ${SERVER_URL}`); } catch(e){ alert('Unable to verify authentication. Please log in again.'); }
        window.location.href = 'login.html';
        return false;
      }
    }

    // Logo options
    const logoList = [
      'axes.png', 'swords.png', 'rings.png', 'kn1.1.png', 'kn2.png', 'kn3.png', 'kn4.png', 'kn5.png', 
      'kn6.png', 'kn7.png', 'kn8.png', 'kn9.png', 'kn10.png', 'cutter.png', 'custom.png'
    ];

    // Tab Management
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
  if (window.dmDebugLog) window.dmDebugLog('[Info] initializeTabs found ' + tabBtns.length + ' buttons');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Remove active class from all tabs and contents
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          btn.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });
  if (window.dmDebugLog) window.dmDebugLog('[Info] initializeTabs attached click handlers');
    }

    // Toggle Switch Functionality
    function initializeToggles() {
      const toggles = document.querySelectorAll('.toggle-switch');
  if (window.dmDebugLog) window.dmDebugLog('[Info] initializeToggles found ' + toggles.length + ' toggles');
  toggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
          toggle.classList.toggle('active');
          const setting = toggle.dataset.setting;
          const isActive = toggle.classList.contains('active');
          
          // Dark mode preference removed from UI; ignore any 'dark-mode' toggles
          if (setting === 'dark-mode') {
            // keep light theme enforced
            applyTheme('light');
          }
          
          // Apply compact layout immediately on client for instant feedback
          if (setting === 'compact-layout') {
            try {
              if (isActive) {
                document.body.classList.add('compact');
                localStorage.setItem('dm_compact', '1');
              } else {
                document.body.classList.remove('compact');
                localStorage.removeItem('dm_compact');
              }
              // Broadcast to other tabs/windows
              try {
                if (window.BroadcastChannel) {
                  const bc = new BroadcastChannel('dm_prefs');
                  bc.postMessage({ type: 'compact', value: !!isActive });
                  bc.close();
                } else {
                  // Fallback: write a timestamped value to localStorage to trigger storage event
                  localStorage.setItem('dm_compact_toggle', JSON.stringify({ v: !!isActive, t: Date.now() }));
                }
              } catch(e){}
            } catch(e){}
          }

          // Update preferences on backend
          updatePreference(setting, isActive);
        });
      });
  if (window.dmDebugLog) window.dmDebugLog('[Info] initializeToggles attached click handlers');
      // Initialize theme based on saved preference
      initializeTheme();
    }

    // Theme Management
    function initializeTheme() {
      // Force light theme as default (Dark Mode removed)
      localStorage.setItem('theme', 'light');
      applyTheme('light');
  // Ensure no legacy dark-mode UI remains active
    }

    function applyTheme(theme) {
      // Only 'light' theme supported here; remove any dark attribute
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('theme', 'light');
    }

    // Update preference on backend
    async function updatePreference(setting, value) {
      try {
        const preferences = { [setting]: value };
        
        // Map frontend setting names to backend preference names
        const mappings = {
          'compact-layout': 'compactLayout',
          'order-emails': 'orderEmails',
          'marketing-emails': 'marketingEmails',
          'newsletter': 'newsletter',
          '2fa': 'twoFactorAuth',
          'login-notifications': 'loginNotifications'
        };

        const backendKey = mappings[setting] || setting;
        const backendPreferences = { [backendKey]: value };

        const currentToken = localStorage.getItem('authToken') || '';
        const response = await fetch(`${SERVER_URL}/api/auth/preferences`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(backendPreferences)
        });

        if (!response.ok) {
          throw new Error('Failed to update preference');
        }

        console.log(`Updated ${setting} to ${value}`);
      } catch (error) {
        console.error('Failed to update preference:', error);
        // Revert toggle state on error
        const toggle = document.querySelector(`[data-setting="${setting}"]`);
        if (toggle) {
          toggle.classList.toggle('active');
        }
      }
    }

    // Load User Data
    async function loadUserData() {
      if (!currentUser) return;

      const userData = currentUser;
      
      // Profile Information
      document.getElementById('account-name').value = userData.name || '';
      document.getElementById('account-username').value = userData.username || userData.name || '';
      document.getElementById('account-email').value = userData.email || '';
      document.getElementById('account-phone').value = userData.phone || '';
      
      // Address Information  
      document.getElementById('account-address').value = userData.address || '';
      document.getElementById('account-city').value = userData.city || '';
      document.getElementById('account-state').value = userData.state || '';
      document.getElementById('account-zip').value = userData.zip || '';
      document.getElementById('account-country').value = userData.country || '';
      
      // Load preferences
      if (userData.preferences) {
        const mappings = {
          'compactLayout': 'compact-layout',
          'orderEmails': 'order-emails',
          'marketingEmails': 'marketing-emails',
          'newsletter': 'newsletter',
          'twoFactorAuth': '2fa',
          'loginNotifications': 'login-notifications'
        };

        Object.entries(userData.preferences).forEach(([backendKey, value]) => {
          const frontendKey = mappings[backendKey] || backendKey;
          const toggle = document.querySelector(`[data-setting="${frontendKey}"]`);
          if (toggle) {
            toggle.classList.toggle('active', value);
          }
        });
        // Apply compact layout to body if requested
        try {
          if (userData.preferences.compactLayout) document.body.classList.add('compact'); else document.body.classList.remove('compact');
        } catch(e){}
      }

    // Load avatar (prefer uploads/avatars when available)
    renderAccountLogo();
      
      // Load order history
      await loadOrderHistory();
      
      // Load wishlist
      await loadWishlistItems();
      
      // Load statistics
      await loadStatistics();
      
      // Load achievements
      await loadAchievements();
    }

    // Avatar Management
    function renderAccountLogo() {
      const logoImg = document.getElementById('current-logo');
      
      if (currentUser && currentUser.logo) {
          // Prefer avatars subfolder when the server returned a avatars path
          try {
            const logo = String(currentUser.logo || '');
            if (logo.indexOf('/uploads/') === 0 && !logo.includes('/uploads/avatars/')) {
              // derive avatars path if likely present
              const base = logo.split('/').pop();
              logoImg.src = '/uploads/avatars/' + base;
            } else {
              logoImg.src = logo;
            }
          } catch (e) { logoImg.src = currentUser.logo; }
          logoImg.style.display = 'block';
        } else {
        // Use default avatar
        logoImg.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#D4AF37"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="24" fill="#1A1612" font-family="Arial">üë§</text></svg>';
        logoImg.style.display = 'block';
      }
    }

  async function showLogoPicker() {
      console.log('showLogoPicker called'); // Debug log
      
      const picker = document.createElement('div');
      picker.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 9999;
      `;
      
      picker.innerHTML = `
        <div style="background: var(--card-bg); padding: 2rem; border-radius: 1rem; 
                    box-shadow: 0 4px 20px var(--shadow-color); max-width: 90vw; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color);">
          <div style="font-size: 1.3rem; color: var(--accent-gold); margin-bottom: 1.5rem; text-align: center;">
            Choose Your Avatar
          </div>
          
          <!-- Custom Upload Section -->
          <div style="text-align: center; margin-bottom: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 0.8rem; border: 1px solid var(--border-color);">
            <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 0.5rem;">üì∏ Upload Custom Image</div>
            <input type="file" id="custom-avatar-file" accept="image/*"  class="u-hidden">
            <button id="upload-custom-btn" style="background: var(--button-bg); color: var(--button-text); border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">Choose Image</button>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">PNG, JPG, GIF up to 5MB</div>
          </div>
          
          <!-- Predefined Avatars -->
          <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 1rem; text-align: center;">Or select from gallery:</div>
          <div id="logo-picker-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
                                            gap: 1rem; margin-bottom: 1.5rem;"></div>
          <div style="text-align: center;">
            <button id="close-logo-picker" style="background: var(--button-bg); color: var(--button-text); border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(picker);
      
      // Handle custom image upload
      const fileInput = picker.querySelector('#custom-avatar-file');
      const uploadBtn = picker.querySelector('#upload-custom-btn');
      
      uploadBtn.onclick = () => fileInput.click();
      
      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          return;
        }

        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }

        try {
          // Upload image to server
          const formData = new FormData();
          formData.append('avatar', file);

          // Read latest token at upload time (in case it changed since page load)
          const currentToken = localStorage.getItem('authToken') || '';

          const uploadResponse = await fetch(`${SERVER_URL}/api/uploads/avatar`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${currentToken}`
            },
            body: formData
          });

          if (!uploadResponse.ok) {
            let bodyText = '';
            try { bodyText = await uploadResponse.text(); } catch (_) {}
            console.error('Avatar upload failed', uploadResponse.status, bodyText);
            alert('Failed to upload image: ' + (bodyText || uploadResponse.status));
            return;
          }

          const uploadResult = await uploadResponse.json();
          const imageUrl = (uploadResult && uploadResult.file && uploadResult.file.url) ? uploadResult.file.url : (uploadResult && uploadResult.url) || null;
          if (!imageUrl) {
            console.error('Upload response missing file URL', uploadResult);
            alert('Upload succeeded but server did not return image URL');
            return;
          }

          // Update profile with new image
          await updateProfileField('logo', imageUrl);
          document.body.removeChild(picker);

        } catch (error) {
          console.error('Upload error:', error);
          alert('Failed to upload image. Check console for details.');
        }
      };
      
      // Handle predefined avatars: try to fetch server-provided avatars first
      const list = picker.querySelector('#logo-picker-list');
      let avatarUrls = [];
      try {
        // Use the public avatars-only endpoint so regular users (and guests) can fetch avatar thumbnails
        const resp = await fetch(`${SERVER_URL}/api/uploads/avatars`);
        if (resp.ok) {
          const d = await resp.json();
          avatarUrls = (d.files || []).filter(f => String(f.url || '').indexOf('/uploads/avatars/') !== -1).map(f => f.url);
        } else if (resp.status === 401) {
          console.warn('Avatars endpoint returned 401 - avatars will fallback to bundled list');
        } else {
          console.warn('Uploads request failed', resp.status);
        }
      } catch (e) {
        console.warn('Failed to fetch uploads list for avatars:', e);
      }

      // Fallback to bundled logoList (root images) if no server avatars found
      const sourceList = (avatarUrls && avatarUrls.length) ? avatarUrls : logoList;

      sourceList.forEach(logo => {
        const img = document.createElement('img');
        img.src = logo;
        img.alt = logo;
        img.style.cssText = `
          width: 64px; height: 64px; border-radius: 50%; cursor: pointer;
          border: 2px solid transparent; transition: all 0.3s ease; object-fit: cover;
        `;
        img.onmouseover = () => img.style.borderColor = 'var(--primary)';
        img.onmouseout = () => img.style.borderColor = 'transparent';
        img.onclick = async () => {
          await updateProfileField('logo', logo);
          document.body.removeChild(picker);
        };
        list.appendChild(img);
      });
      
      picker.querySelector('#close-logo-picker').onclick = () => {
        document.body.removeChild(picker);
      };
    }

    // Update profile field on backend
    async function updateProfileField(field, value) {
      try {
        const currentToken = localStorage.getItem('authToken') || '';
        const response = await fetch(`${SERVER_URL}/api/auth/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({ [field]: value })
        });

        if (response.ok) {
          const result = await response.json();
          currentUser = result.user;
          renderAccountLogo();
          // Persist minimal profile info to localStorage so other pages (index.html) can show the avatar
          try {
            const email = (currentUser && (currentUser.email || currentUser.username)) ? (currentUser.email || currentUser.username) : null;
            if (email) {
              try {
                if (typeof setUserProfile === 'function') {
                  setUserProfile(email, { logo: currentUser.logo || '', name: currentUser.name || '', email: currentUser.email || '' });
                } else {
                  const users = (typeof getUsersMap === 'function') ? getUsersMap() : JSON.parse(localStorage.getItem('users') || '{}');
                  users[email] = users[email] || {};
                  users[email].logo = currentUser.logo || users[email].logo || '';
                  users[email].name = currentUser.name || users[email].name || '';
                  users[email].email = currentUser.email || users[email].email || '';
                  localStorage.setItem('users', JSON.stringify(users));
                }
                localStorage.setItem('currentUser', email);
                localStorage.setItem('userLoggedIn', 'true');
                // Touch a timestamp key to ensure other open pages receive a storage event
                localStorage.setItem('profileUpdatedAt', String(Date.now()));
              } catch(e) { console.warn('Persist profile failed', e); }
            }
            // If the index page is open in another window/tab, the storage event will notify it.
            // If this account page was opened from the index as a popup, call the opener updater directly.
            if (window.opener && typeof window.opener.updateAccountLogo === 'function') {
              try { window.opener.updateAccountLogo(); } catch (_) {}
            }
          } catch (e) {
            console.warn('Failed to persist profile to localStorage', e);
          }

          console.log(`Updated ${field} successfully`);
        } else {
          throw new Error('Failed to update profile');
        }
      } catch (error) {
        console.error('Failed to update profile:', error);
        alert('Failed to update profile. Please try again.');
      }
    }

    // Also persist profile after saving full settings (saveAccountSettings uses same endpoint)
    // Wrap original saveAccountSettings to persist local copy when server responds

    // Order History
    async function loadOrderHistory() {
      try {
        const response = await fetch(`${SERVER_URL}/api/user/orders`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          const orderHistoryDiv = document.getElementById('order-history');
          
          if (data.orders && data.orders.length > 0) {
            orderHistoryDiv.innerHTML = data.orders.map((order, index) => `
              <div class="preference-item">
                <div>
                  <strong>Order #${order.id || (index + 1)}</strong>
                  <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">
                    ${order.items?.length || 0} items - $${order.total || 0} - ${order.status || 'completed'}
                  </p>
                  <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.8rem;">
                    ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : ''}
                  </p>
                </div>
                <span style="color:var(--primary);">‚úÖ</span>
              </div>
            `).join('');
          } else {
            orderHistoryDiv.innerHTML = `
              <p style="text-align:center;color:var(--text-muted);padding:2rem;">
                No orders found. <a href="index.html" style="color:var(--primary);">Start shopping!</a>
              </p>
            `;
          }
        }
      } catch (error) {
        console.error('Failed to load orders:', error);
      }
    }

    // Wishlist Items
    async function loadWishlistItems() {
      try {
        const wishlistDiv = document.getElementById('wishlist-items');
        // Try fetching server wishlist
        let serverWishlist = [];
        try {
          const response = await fetch(`${SERVER_URL}/api/wishlist`, { headers: { 'Authorization': `Bearer ${authToken}` } });
          if (response.ok) {
            const data = await response.json();
            serverWishlist = Array.isArray(data.wishlist) ? data.wishlist.slice() : [];
          }
        } catch (e) { console.warn('Failed to fetch server wishlist', e); }

        // Local per-user wishlist from helper
        let localWL = [];
        try { if (typeof getWishlist === 'function') localWL = getWishlist() || []; } catch (e) { localWL = []; }

        // If server empty but local has items, push local items to server (best-effort)
        if ((!serverWishlist || serverWishlist.length === 0) && localWL && localWL.length > 0 && authToken) {
          for (const it of localWL) {
            try {
              await fetch(`${SERVER_URL}/api/wishlist`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ productId: it.id || it.gallery || '', title: it.title || '', price: it.price || 0, img: it.img || '', album: it.album || '' })
              });
            } catch (e) { /* ignore individual failures */ }
          }
          try { const r2 = await fetch(`${SERVER_URL}/api/wishlist`, { headers: { 'Authorization': `Bearer ${authToken}` } }); if (r2.ok) { const d2 = await r2.json(); serverWishlist = Array.isArray(d2.wishlist) ? d2.wishlist : serverWishlist; } } catch(e){}
        }

        const finalList = (serverWishlist && serverWishlist.length) ? serverWishlist : (localWL || []);

        if (finalList && finalList.length > 0) {
          wishlistDiv.innerHTML = finalList.map(item => `
              <div class="preference-item">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <img src="${item.img}" alt="${item.title}" style="width: 48px; height: 48px; border-radius: 0.5rem; object-fit: cover;">
                  <div>
                    <strong>${item.title}</strong>
                    <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">$${item.price}</p>
                  </div>
                </div>
                <button onclick="removeFromWishlist('${item.id}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem;">üóëÔ∏è</button>
              </div>
            `).join('');
        } else {
          wishlistDiv.innerHTML = `
              <p style="text-align:center;color:var(--text-muted);padding:2rem;">Your wishlist is empty.</p>
            `;
        }
      } catch (error) {
        console.error('Failed to load wishlist:', error);
      }
    }

    // Remove from wishlist
    async function removeFromWishlist(productId) {
      try {
        const response = await fetch(`${SERVER_URL}/api/wishlist/${productId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          await loadWishlistItems(); // Reload wishlist
          await loadStatistics(); // Update stats
        } else {
          throw new Error('Failed to remove item');
        }
      } catch (error) {
        console.error('Failed to remove from wishlist:', error);
        alert('Failed to remove item from wishlist.');
      }
    }

    // Statistics
    async function loadStatistics() {
      try {
        const response = await fetch(`${SERVER_URL}/api/user/stats`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          const stats = data.stats;
          
          // Update display
          document.getElementById('total-orders').textContent = stats.totalOrders || 0;
          document.getElementById('total-spent').textContent = `$${stats.totalSpent || 0}`;
          document.getElementById('wishlist-count').textContent = stats.wishlistCount || 0;
          document.getElementById('member-since').textContent = stats.memberSince || new Date().getFullYear();

          // Update achievements
          const achievementsDiv = document.getElementById('achievements');
          if (stats.achievements) {
            achievementsDiv.innerHTML = stats.achievements.map(achievement => `
              <div class="preference-item">
                <div>
                  <strong>${achievement.unlocked ? 'üèÜ' : 'üîí'} ${achievement.name}</strong>
                  <p style="margin:0.3rem 0 0 0;color:var(--text-muted);font-size:0.9rem;">${achievement.description}</p>
                </div>
                <span style="color:${achievement.unlocked ? 'var(--primary)' : 'var(--text-muted)'};">${achievement.unlocked ? '‚úÖ' : 'üîí'}</span>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Failed to load statistics:', error);
      }
    }

    // Achievements Management
    async function loadAchievements() {
      if (!currentUser) return;
      
      // Define achievement criteria
      const achievements = [
        {
          id: 'first_purchase',
          name: 'First Purchase',
          description: 'Made your first order',
          icon: 'üõí',
          unlocked: false
        },
        {
          id: 'premium_collector',
          name: 'Premium Collector',
          description: 'Spent over $500',
          icon: 'üí∞',
          unlocked: false
        },
        {
          id: 'wishlist_enthusiast',
          name: 'Wishlist Enthusiast',
          description: 'Added 10+ items to wishlist',
          icon: '‚ù§Ô∏è',
          unlocked: false
        },
        {
          id: 'loyal_customer',
          name: 'Loyal Customer',
          description: 'Made 5+ orders',
          icon: 'üèÜ',
          unlocked: false
        },
        {
          id: 'blade_master',
          name: 'Blade Master',
          description: 'Purchased from all collections',
          icon: '‚öîÔ∏è',
          unlocked: false
        }
      ];
      
      // Check achievement criteria
      const totalOrders = currentUser.orders?.length || 0;
      const totalSpent = currentUser.totalSpent || 0;
      const wishlistCount = currentUser.wishlist?.length || 0;
      
      // Update achievement status
      achievements[0].unlocked = totalOrders > 0; // First Purchase
      achievements[1].unlocked = totalSpent >= 500; // Premium Collector
      achievements[2].unlocked = wishlistCount >= 10; // Wishlist Enthusiast
      achievements[3].unlocked = totalOrders >= 5; // Loyal Customer
      achievements[4].unlocked = totalOrders >= 3; // Blade Master (simplified)
      
      // Render achievements
      const achievementsList = document.getElementById('achievements-list');
      if (achievementsList) {
        achievementsList.innerHTML = achievements.map(achievement => `
          <div class="achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}">
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-info">
              <div class="achievement-title">${achievement.name}</div>
              <div class="achievement-desc">${achievement.description}</div>
            </div>
            <div class="achievement-status">${achievement.unlocked ? '‚úÖ' : 'üîí'}</div>
          </div>
        `).join('');
      }
      
      // Update progress bars
      updateProgressBars(totalOrders, totalSpent, wishlistCount);
    }
    
    function updateProgressBars(orders, spending, wishlistItems) {
      // Orders progress (target: 10)
      const orderProgress = Math.min((orders / 10) * 100, 100);
  const ordersEl = document.getElementById('orders-progress');
  const ordersFill = document.getElementById('orders-progress-fill');
  if (ordersEl) ordersEl.textContent = `${orders}/10`;
  if (ordersFill) ordersFill.style.width = `${orderProgress}%`;
      
      // Spending progress (target: $500)
      const spendingProgress = Math.min((spending / 500) * 100, 100);
  const spendingEl = document.getElementById('spending-progress');
  const spendingFill = document.getElementById('spending-progress-fill');
  if (spendingEl) spendingEl.textContent = `$${spending}/$500`;
  if (spendingFill) spendingFill.style.width = `${spendingProgress}%`;
      
      // Wishlist progress (target: 10)
      const wishlistProgress = Math.min((wishlistItems / 10) * 100, 100);
  const wlEl = document.getElementById('wishlist-progress');
  const wlFill = document.getElementById('wishlist-progress-fill');
  if (wlEl) wlEl.textContent = `${wishlistItems}/10`;
  if (wlFill) wlFill.style.width = `${wishlistProgress}%`;
    }

    // Password Toggle Function
    function toggleAccountPassword(inputId) {
      const input = document.getElementById(inputId);
      const eyeSpan = document.getElementById('eye-' + inputId);
      if (!input) return;
      const openEye = '&#128065;';
      const slashedEye = '&#128065;&#x0338;';
      if (input.type === 'password') {
        input.type = 'text';
        if (eyeSpan) eyeSpan.innerHTML = openEye; // visible
        // keep text alignment unchanged so text position is fixed
      } else {
        input.type = 'password';
        if (eyeSpan) eyeSpan.innerHTML = slashedEye; // slashed when masked
      }
    }

    // Password Change
    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill in all password fields.');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('New passwords do not match.');
        return;
      }
      
      if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long.');
        return;
      }
      
      try {
        const currentToken = localStorage.getItem('authToken') || '';
        const response = await fetch(`${SERVER_URL}/api/auth/change-password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            currentPassword,
            newPassword
          })
        });

        if (response.ok) {
          // Clear fields
          document.getElementById('current-password').value = '';
          document.getElementById('new-password').value = '';
          document.getElementById('confirm-password').value = '';
          
          alert('Password updated successfully!');
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to update password');
        }
      } catch (error) {
        console.error('Password change error:', error);
        alert('Failed to update password. Please try again.');
      }
    }

    // Save Account Settings
    async function saveAccountSettings() {
      try {
        const profileData = {
          name: document.getElementById('account-name').value,
          username: document.getElementById('account-username').value,
          phone: document.getElementById('account-phone').value,
          address: document.getElementById('account-address').value,
          city: document.getElementById('account-city').value,
          state: document.getElementById('account-state').value,
          zip: document.getElementById('account-zip').value,
          country: document.getElementById('account-country').value
        };

        const currentToken = localStorage.getItem('authToken') || '';
        const response = await fetch(`${SERVER_URL}/api/auth/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(profileData)
        });

        if (response.ok) {
          const result = await response.json();
          currentUser = result.user;
          alert('Account settings saved successfully!');
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to save settings');
        }
      } catch (error) {
        console.error('Save settings error:', error);
        alert('Failed to save settings. Please try again.');
      }
    }

    // Navigation functions
    function goHome() {
      window.location.href = 'index.html';
    }

    function logout() {
      try {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userLoggedIn');
        // emit storage key so other tabs update immediately
        localStorage.setItem('profileUpdatedAt', String(Date.now()));
      } catch (e) { console.warn('logout failed', e); }
      alert('You have been logged out successfully.');
      // Redirect back to index
      window.location.href = 'index.html';
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication first
      const isAuthenticated = await checkAuth();
      if (!isAuthenticated) return;

      // Apply locally persisted compact preference immediately
      try {
        if (localStorage.getItem('dm_compact')) document.body.classList.add('compact'); else document.body.classList.remove('compact');
      } catch(e){}

      // Listen for compact preference changes from other tabs
      try {
        if (window.BroadcastChannel) {
          const bc = new BroadcastChannel('dm_prefs');
          bc.addEventListener('message', (ev)=>{
            try { if (ev.data && ev.data.type === 'compact') { if (ev.data.value) document.body.classList.add('compact'); else document.body.classList.remove('compact'); } } catch(e){}
          });
        } else {
          window.addEventListener('storage', function(e){
            try { if (!e) return; if (e.key === 'dm_compact_toggle') { const obj = JSON.parse(e.newValue||'{}'); if (obj && obj.v) document.body.classList.add('compact'); else document.body.classList.remove('compact'); } } catch(e){}
          });
        }
      } catch(e){}

      // Initialize components
      initializeTabs();
      initializeToggles();
      
      // Check for hash navigation
      if (window.location.hash === '#orders') {
        // Open orders tab
        const ordersTab = document.querySelector('[data-tab="orders"]');
        if (ordersTab) {
          ordersTab.click();
        }
      }
      
      // Load user data
      await loadUserData();

      // Logo change button
      const changeLogoBtn = document.getElementById('change-logo-btn');
      const nativeUploadInput = document.getElementById('custom-avatar-upload');
      (function(){
        try {
          const dbg = document.createElement('pre');
          dbg.id = 'dm-debug-overlay';
          dbg.style.cssText = 'position:fixed;right:12px;bottom:12px;max-width:420px;max-height:45vh;overflow:auto;background:rgba(0,0,0,0.75);color:#fff;padding:10px;border-radius:8px;z-index:100000;font-size:12px;line-height:1.3;display:none;white-space:pre-wrap;backdrop-filter:blur(4px);';
          dbg.textContent = 'Debug overlay initialized...';
          document.body.appendChild(dbg);

          function show(msg){ dbg.style.display = 'block'; dbg.textContent += '\n' + msg; }

          window.addEventListener('error', function(e){
            try { show('[Error] ' + (e.message || e.error || 'unknown') + ' @ ' + (e.filename || '') + ':' + (e.lineno || '') ); } catch(_){}
          });

          window.addEventListener('unhandledrejection', function(ev){
            try { const r = ev.reason; show('[Rejection] ' + (r && r.message ? r.message : JSON.stringify(r))); } catch(_){}
          });

          // Helpful heartbeat so we see the script ran
          document.addEventListener('DOMContentLoaded', function(){ show('[Info] DOMContentLoaded fired'); });
          window.addEventListener('load', function(){ show('[Info] Window load fired'); });

          // Expose quick helpers to clear overlay and log messages
          window.dmDebugClear = function(){ dbg.textContent = '[Debug cleared]'; };
          window.dmDebugLog = function(msg){ try { dbg.style.display = 'block'; dbg.textContent += '\n' + msg; } catch(e){} };
        } catch (e) { /* don't break page */ }
      })();
      if (changeLogoBtn) {
        changeLogoBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Avatar button clicked!');
          try {
            showLogoPicker();
          } catch (err) {
            console.error('showLogoPicker failed, falling back to native file input', err);
            if (nativeUploadInput) nativeUploadInput.click();
          }
        });
        console.log('Avatar button event listener added successfully');
      } else {
        console.error('change-logo-btn element not found!');
      }

      // Fallback: handle native hidden input for direct uploads
      if (nativeUploadInput) {
        nativeUploadInput.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          // Validate file
          if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
          }
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('avatar', file);
            const currentToken = localStorage.getItem('authToken') || '';
            const uploadResponse = await fetch(`${SERVER_URL}/api/uploads/avatar`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${currentToken}`
              },
              body: formData
            });

            if (!uploadResponse.ok) {
              let bodyText = '';
              try { bodyText = await uploadResponse.text(); } catch (_) {}
              console.error('Avatar upload failed', uploadResponse.status, bodyText);
              alert('Failed to upload image: ' + (bodyText || uploadResponse.status));
              return;
            }

            const uploadResult = await uploadResponse.json();
            const imageUrl = (uploadResult && uploadResult.file && uploadResult.file.url) ? uploadResult.file.url : (uploadResult && uploadResult.url) || null;
            if (!imageUrl) {
              console.error('Upload response missing file URL', uploadResult);
              alert('Upload succeeded but server did not return image URL');
              return;
            }

            // Update profile with new image
            await updateProfileField('logo', imageUrl);
            // Clear input selection
            nativeUploadInput.value = '';

          } catch (error) {
            console.error('Upload error (native input):', error);
            alert('Failed to upload image. Check console for details.');
          }
        });
      }
    });

  // Make functions globally available
  window.changePassword = changePassword;
  window.saveAccountSettings = saveAccountSettings;
  window.goHome = goHome;
  window.logout = logout;
  window.removeFromWishlist = removeFromWishlist;
  </script>

  <!-- Delete Account Modal (injected HTML by JS if needed) -->
  <script>
    function showDeleteAccountModal(){
      // Build modal
      const modal = document.createElement('div');
      modal.id = 'delete-account-modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100000;';

      modal.innerHTML = `
        <div style="background:var(--card-bg);padding:1.6rem;border-radius:10px;max-width:520px;width:96%;border:1px solid var(--border-color);position:relative;">
          <button id="delete-modal-close" aria-label="Close" style="position:absolute;top:8px;right:8px;background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--text-secondary)">‚úñ</button>
          <h3 style="margin-top:0;color:var(--primary);">Delete Account</h3>
          <p style="color:var(--text-secondary);">This will permanently remove your account and all associated data. To continue, enter your password and confirm via 2FA.</p>
          <div style="margin:0.6rem 0;"><label>Password</label><input type="password" id="confirm-delete-password" autocomplete="current-password" style="width:100%;padding:0.6rem;margin-top:0.3rem;border-radius:6px;border:1px solid var(--border-color);"></div>
          <div id="delete-account-error"  class="u-hidden"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:0.6rem;">
            <button id="cancel-delete-btn" style="background:var(--card-bg);border:1px solid var(--border-color);padding:0.6rem 1rem;border-radius:6px;">Cancel</button>
            <button id="send-2fa-delete-btn" style="background:#b04b3b;color:#fff;border:none;padding:0.6rem 1rem;border-radius:6px;">Send 2FA Code</button>
          </div>
          <div id="delete-2fa-section"  class="u-hidden">
            <div style="margin-bottom:0.6rem;"><label>2FA Code</label><input type="text" id="delete-2fa-code" style="width:100%;padding:0.6rem;margin-top:0.3rem;border-radius:6px;border:1px solid var(--border-color);"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;"><button id="confirm-delete-btn" style="background:#7c1b1b;color:#fff;border:none;padding:0.6rem 1rem;border-radius:6px;">Confirm Delete</button></div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector('#cancel-delete-btn').addEventListener('click', ()=> {
        // clear any running interval attached to the send button
        try { const btn = modal.querySelector('#send-2fa-delete-btn'); if (btn && btn._dm_interval) { clearInterval(btn._dm_interval); btn._dm_interval = null; } } catch(e){}
        modal.remove();
      });

      // Close (top-right) button
      const closeBtn = modal.querySelector('#delete-modal-close');
      if (closeBtn) closeBtn.addEventListener('click', ()=>{
        try { const btn = modal.querySelector('#send-2fa-delete-btn'); if (btn && btn._dm_interval) { clearInterval(btn._dm_interval); btn._dm_interval = null; } } catch(e){}
        modal.remove();
      });

      // helper: manage 2FA send state stored per-email so refresh preserves countdown
      function get2FAKey(email){ return `dm_2fa_send_${String(email||'').toLowerCase()}`; }
      function getNow(){ return Date.now(); }
      async function start2FASendFlow(email, button, errDisplay){
        const key = get2FAKey(email);
        const expiresAt = getNow() + 10*60*1000; // 10 minutes
        // persist expiry so refresh keeps timer
        localStorage.setItem(key, String(expiresAt));
        button.disabled = true;
        updateButtonCountdown(button, expiresAt);
        // ensure interval to update label
        button._dm_interval = setInterval(()=> updateButtonCountdown(button, expiresAt), 1000);
      }

      function updateButtonCountdown(button, expiresAt){
        const left = Math.max(0, Math.floor((expiresAt - getNow())/1000));
        if (left <= 0){
          button.disabled = false;
          button.textContent = 'Send 2FA Code';
          if (button._dm_interval){ clearInterval(button._dm_interval); button._dm_interval = null; }
          return;
        }
        const mins = Math.floor(left/60); const secs = left%60;
        button.textContent = `Send 2FA Code (${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')})`;
      }

      modal.querySelector('#send-2fa-delete-btn').addEventListener('click', async ()=>{
        const pwd = document.getElementById('confirm-delete-password').value || '';
        const err = document.getElementById('delete-account-error');
        err.style.display = 'none'; err.textContent = '';
        if (!pwd) { err.style.display='block'; err.textContent='Please enter your password.'; return; }
        try {
          const token = localStorage.getItem('authToken') || '';
          // Immediately disable button to prevent duplicate submissions
          const sendBtn = modal.querySelector('#send-2fa-delete-btn');
          sendBtn.disabled = true;
          sendBtn.dataset._dm_disabled_at = String(Date.now());

          // Validate password first
          const resp = await fetch(`${SERVER_URL}/api/auth/validate-password`, {
            method: 'POST', headers: { 'Content-Type':'application/json','Authorization': 'Bearer '+token }, body: JSON.stringify({ password: pwd })
          });
          const j = await resp.json();
          if (!resp.ok) { err.style.display='block'; err.textContent = j.error || 'Password validation failed'; return; }

          const email = j.email;
          const key = get2FAKey(email);
          const existing = parseInt(localStorage.getItem(key) || '0', 10);
          const now = getNow();
          if (existing && existing > now){
            // Already sent and still valid: resume countdown
            const expiresAt = existing;
            const btn = modal.querySelector('#send-2fa-delete-btn');
            btn.disabled = true;
            updateButtonCountdown(btn, expiresAt);
            btn._dm_interval = setInterval(()=> updateButtonCountdown(btn, expiresAt), 1000);
            modal.querySelector('#delete-2fa-section').style.display = 'block';
            return;
          }

          // Request 2FA send (include auth token so server may allow deletion 2FA even if 2FA not enabled)
          const token2 = localStorage.getItem('authToken') || '';
          const sendResp = await fetch(`${SERVER_URL}/api/auth/2fa/send-code`, { method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization': token2 ? 'Bearer '+token2 : '' }, body: JSON.stringify({ email: email, password: pwd }) });
          const sj = await sendResp.json();
          if (!sendResp.ok) { err.style.display='block'; err.textContent = sj.error || 'Failed to send 2FA code'; sendBtn.disabled = false; return; }

          // Show 2FA section and start persisted countdown
          modal.querySelector('#delete-2fa-section').style.display = 'block';
          await start2FASendFlow(email, modal.querySelector('#send-2fa-delete-btn'), err);

        } catch (e) {
          console.error('2FA send error', e);
          err.style.display='block'; err.textContent = 'Request failed';
        }
      });

      modal.querySelector('#confirm-delete-btn').addEventListener('click', async ()=>{
        const code = document.getElementById('delete-2fa-code').value || '';
        const pwd = document.getElementById('confirm-delete-password').value || '';
        const err = document.getElementById('delete-account-error');
        err.style.display='none'; err.textContent = '';
        if (!code) { err.style.display='block'; err.textContent='Please enter the 2FA code.'; return; }
        try {
          const token = localStorage.getItem('authToken') || '';
          // Call delete endpoint with password and 2FA code; server will verify both
          const delResp = await fetch(`${SERVER_URL}/api/auth/delete-account`, { method: 'DELETE', headers: { 'Content-Type':'application/json','Authorization': 'Bearer '+token }, body: JSON.stringify({ password: pwd, code }) });
          const dj = await delResp.json();
          if (!delResp.ok) { err.style.display='block'; err.textContent = dj.error || 'Account deletion failed'; return; }

          // Success: remove local storage and redirect
          localStorage.removeItem('authToken'); localStorage.removeItem('currentUser'); localStorage.setItem('profileUpdatedAt', String(Date.now()));
          alert('Your account and data have been deleted.');
          window.location.href = 'index.html';

        } catch (e) { err.style.display='block'; err.textContent='Deletion failed'; }
      });
    }
  </script>
</body>
</html>
