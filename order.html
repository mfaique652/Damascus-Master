<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order - Damascus Master</title>
  <style>
    :root {
      /* White / light theme for order page */
      --bg: #ffffff;
      --card: #ffffff;
      --ink: #111111; /* primary text color */
      --muted: #6b7280; /* secondary text */
      --primary: #111111; /* headings / titles */
      --accent: #ffb347;
      --danger: #ff4444;
      --shadow: 0 6px 22px rgba(2,8,23,0.06);
      --radius: 0.6rem;
    }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--ink);
      font-family: Montserrat, Roboto, Arial, sans-serif;
    }
    .container {
      max-width: 1100px; margin: 1.5rem auto; padding: 0 1rem; background: linear-gradient(180deg,#fff,#fbfcff);
    }
    h1 { color: var(--primary); margin: 0.5rem 0 1rem; font-size: 1.8rem; text-align: center; }
    .order-wrap {
      display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: start;
    }
    @media (max-width: 900px) { .order-wrap { grid-template-columns: 1fr; } }

    .card {
      background: var(--card);
      border-radius: calc(var(--radius) + 0.2rem);
      box-shadow: 0 12px 36px rgba(16,24,40,0.06);
      padding: 1rem 1.1rem;
      border: 1px solid rgba(10,12,18,0.04);
      overflow: hidden;         /* smooth clipped corners */
    }

    /* Items */
    .items-list { display: flex; flex-direction: column; gap: 0.8rem; }
  .item { display: grid; grid-template-columns: 84px 1fr auto; gap: 0.9rem; align-items: start; background:linear-gradient(180deg,#ffffff,#fbfcff); border-radius: 0.8rem; padding: 0.7rem; position: relative; overflow: hidden; border: 1px solid rgba(15,20,30,0.03); }
  .item img.main { width: 84px; height: 84px; object-fit: cover; border-radius: 0.6rem; background:#f7f7f9; border: 1px solid rgba(15,20,30,0.04); }
  .item { transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .item::before { content: ""; position: absolute; inset: 0 0 0 0; pointer-events: none; }
  .item::after { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, rgba(255,179,71,0.95), rgba(255,136,0,0.95)); opacity: 0.95; }
  .item:hover { transform: translateY(-2px); box-shadow: 0 6px 22px rgba(0,0,0,0.25); }
  .item-title { color: var(--ink); font-weight: 700; margin-bottom: 0.2rem; }
  .item-desc { color: var(--muted); font-size: 0.92rem; margin-bottom: 0.3rem; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
  .item-desc.expanded { display: block; -webkit-line-clamp: unset; line-clamp: unset; overflow: visible; }
  .show-more-btn { background: none; border: none; color: #ffb347; text-decoration: underline; cursor: pointer; padding: 0; font-size: 0.9rem; }
  .item-details { 
    color: #cccccc; 
    font-size: 0.9rem; 
    line-height: 1.35; 
    background: rgba(25, 28, 35, 0.5); 
    border-radius: 0.6rem; 
    padding: 0.8rem; 
    margin: 0.5rem 0;
    text-align: left;
  }
  .item-details b { color: #ffe066; font-weight: 600; }
  .thumbs { display: flex; gap: 0.3rem; margin-top: 0.4rem; overflow-x: auto; justify-content: center; }
  .thumbs img { width: 40px; height: 40px; border-radius: 0.45rem; object-fit: cover; background:#13161c; transition: transform 0.12s ease; border: 1px solid #2a2f3a; }
  .thumbs img:hover { transform: scale(1.06); }
  .item-price { 
    position: absolute;
    bottom: 0.8rem;
    right: 0.8rem;
    background: linear-gradient(90deg,#fff7eb,#fff0d6);
    color: #231f20;
    padding: 0.36rem 0.8rem;
    border-radius: 0.6rem;
    font-weight: 800;
    font-size: 1rem;
    box-shadow: 0 6px 18px rgba(16,24,40,0.06);
    border: 1px solid rgba(0,0,0,0.04);
  }
  .item-meta { color: var(--muted); font-size: 0.85rem; margin-top: 0.25rem; }
  /* Remove button on each item */
  .item-remove {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 1px solid #2a2f3a;
    background: rgba(20,22,28,0.85);
    color: #ff6666;
    font-size: 18px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    z-index: 2;
    transition: background 0.15s ease, color 0.15s ease, transform 0.12s ease;
  }
  .item-remove:hover { background: rgba(35,38,47,0.95); color: #ff0000; transform: scale(1.05); }

    /* Totals */
  .totals { display: grid; gap: 0.35rem; }
  .totals-row { display:flex; justify-content: space-between; }
  .totals-row .label { color: var(--muted); }
  .totals-row .value { color: var(--ink); font-weight: 600; }
  .totals-row.total .label { color: var(--muted); font-weight: 700; }
  .totals-row.total .value { color: var(--ink); font-weight: 800; }

    /* Forms */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
    .form-grid-1 { display:grid; grid-template-columns: 1fr; gap: 0.6rem; }
    @media (max-width:700px) { .form-grid { grid-template-columns: 1fr; } }
    label { font-size: 0.9rem; color: var(--muted); }
    input, select, textarea {
      width: 100%; padding: 0.5rem 0.8rem; border-radius: 0.6rem; border: 1px solid rgba(10,12,18,0.06); background: #ffffff; color: var(--ink); font-size: 0.95rem; height: 40px;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
  /* Card input UI */
  .card-field { position: relative; }
  /* Ensure inputs in a card-field leave space for the logo to avoid overlap */
  .card-field input { padding-right: 64px; }
  .card-brand { position: absolute; right: 12px; top: 50%; transform: translateY(-40%); display:flex; align-items:center; gap:8px; font-weight:700; color:#102133; pointer-events: none; z-index: 3; }
  .card-brand .logo { width:36px; height:24px; display:inline-block; background-size:contain; background-repeat:no-repeat; background-position:center; }
  .card-number { letter-spacing: 0.02em; font-family: ui-monospace, SFMono-Regular, Menlo, monospace }
  .card-hint { font-size:0.9rem; color:#7b8794; margin-top:6px }
    input::placeholder, textarea::placeholder { color: #9aa0a6; opacity: 1; font-size: 0.9rem; }
    input, select, textarea { box-sizing: border-box; }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: rgba(255,179,71,0.95); box-shadow: 0 0 0 4px rgba(255,179,71,0.05);
    }
  .pay-methods { display:flex; gap: 1rem; margin: 0.6rem 0; align-items:center }
  .pay-methods label{ display:inline-flex; gap:8px; align-items:center; font-weight:600 }
  .pay-card { display: grid; gap: 0.8rem; margin-top:8px }
  .pay-submit { display:flex; gap: 0.75rem; align-items:center; }
    .btn {
      background: linear-gradient(90deg,#ffb347,#ff8800); color:#181a20; border: 0; padding: 0.7rem 1.1rem; border-radius: 0.8rem; font-weight:800; cursor:pointer; box-shadow: 0 8px 18px rgba(255,140,0,0.08);
    }
    .btn:hover { filter: brightness(1.05); }
    .back-link { color: #89b4ff; text-decoration: underline; cursor: pointer; }
  .notice { color: var(--muted); font-size: 0.95rem; }
  .muted-small { color: #8b98a6; font-size:0.9rem }
    .ok { color: #9cff9c; }
    .err { color: var(--danger); }
    /* Sticky summary on larger screens */
    @media (min-width: 901px) {
      .right > .card { position: sticky; top: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Confirm your order</h1>
    <div id="emptyState" class="card u-hidden" >
      No items to order. <a href="index.html" class="back-link">Go back</a>
    </div>

    <div class="order-wrap u-hidden" id="orderWrap" >
      <div class="left">
        <div class="card">
          <h2 style="margin:0 0 0.6rem;">Items</h2>
          <div id="items" class="items-list"></div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <h2 style="margin:0 0 0.6rem;">Shipping details</h2>
          <div class="form-grid">
            <div>
              <label>Full name</label>
              <input id="ship_name" placeholder="John Doe" />
            </div>
            <div>
              <label>Email</label>
              <input id="ship_email" type="email" placeholder="john@example.com" />
            </div>
            <div>
              <label>Phone</label>
              <input id="ship_phone" placeholder="+1 555 123 4567" />
            </div>
            <div>
              <label>Country</label>
              <input id="ship_country" placeholder="USA" />
            </div>
            <div>
              <label>City</label>
              <input id="ship_city" placeholder="Houston" />
            </div>
            <div>
              <label>State/Province</label>
              <input id="ship_state" placeholder="TX" />
            </div>
            <div>
              <label>Postal/ZIP</label>
              <input id="ship_zip" placeholder="77084" />
            </div>
            <div>
              <label>Address</label>
              <input id="ship_address" placeholder="1661 W Little York Rd" />
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <h2 style="margin:0 0 0.6rem;">Payment</h2>
          <div class="pay-methods">
            <label><input type="radio" name="pay" value="card" checked onchange="togglePay('card')" /> Card</label>
            <label><input type="radio" name="pay" value="paypal" onchange="togglePay('paypal')" /> PayPal</label>
          </div>

          <div id="payCard" class="pay-card">
            <div class="form-grid">
              <div>
                <label>Cardholder name</label>
                <input id="cc_name" name="cc-name" autocomplete="cc-name" placeholder="John Doe" />
              </div>
              <div>
                <label>Card number</label>
                <input id="cc_number" name="cc-number" autocomplete="cc-number" inputmode="numeric" placeholder="4111 1111 1111 1111" />
              </div>
              <div>
                <label>Expiry (MM/YY)</label>
                <input id="cc_exp" name="cc-exp" autocomplete="cc-exp" placeholder="12/27" />
              </div>
              <div>
                <label>CVV</label>
                <input id="cc_cvv" name="cc-csc" autocomplete="cc-csc" placeholder="123" />
              </div>
            </div>
            <div class="pay-submit">
              <button class="btn" onclick="payWithCard()">Pay now</button>
              <div style="display:flex;flex-direction:column">
                <span id="cardNotice" class="notice">Secure payment — processed by the configured gateway.</span>
                <span class="muted-small">No card data is stored by the site.</span>
              </div>
            </div>
            <div id="cardMsg" class="notice"></div>
          </div>

          <div id="payPaypal"  class="u-hidden">
            <div id="paypal-button-container"></div>
            <div class="notice">PayPal is loaded from server config. Ensure the backend .env has your Live Client ID and Secret.</div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h2 style="margin:0 0 0.6rem;">Summary</h2>
          <div id="totals" class="totals"></div>
          <div style="margin-top:0.6rem; font-size:0.9rem; color:var(--muted);">Prices in USD.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const currency = 'USD';
  let orderItems = [];
  let paypalLoaded = false;
  const backendBase = (location.origin && location.origin !== 'null' && location.protocol.startsWith('http')) ? location.origin : 'http://localhost:3025';

    function format(n){ return '$' + Number(n || 0).toFixed(2); }

    // --- Card input helpers: formatting, brand detection, basic validation ---
    const cardBrands = [
      { name: 'visa', pattern: /^4/, logo: 'url("/uploads/payments/visa.svg")' },
      { name: 'mastercard', pattern: /^5[1-5]/, logo: 'url("/uploads/payments/mastercard.svg")' },
      { name: 'amex', pattern: /^3[47]/, logo: 'url("/uploads/payments/americanexpress.svg")' },
      { name: 'discover', pattern: /^(6011|65|64[4-9])/, logo: 'url("/uploads/payments/discover.svg")' },
      { name: 'jcb', pattern: /^35/, logo: 'url("/uploads/payments/jcb.svg")' },
      { name: 'dinersclub', pattern: /^(36|38|30[0-5])/, logo: 'url("/uploads/payments/dinersclub.svg")' },
    ];

    function detectCardBrand(num) {
      const n = String(num).replace(/\D/g,'');
      for (const b of cardBrands) if (b.pattern.test(n)) return b;
      return null;
    }

    function luhnCheck(num) {
      const s = String(num).replace(/\D/g,''); if (!s) return false;
      let sum = 0, alt = false; for (let i = s.length - 1; i >= 0; i--) { let d = parseInt(s.charAt(i), 10); if (alt) { d *= 2; if (d>9) d -= 9; } sum += d; alt = !alt; } return (sum % 10) === 0;
    }

    function formatCardNumber(v) {
      const digits = v.replace(/\D/g,'').slice(0,19);
      // group by 4 for most cards; AMEX uses 4-6-5 but we'll use 4-4-4-... for simplicity
      return digits.replace(/(.{4})/g, '$1 ').trim();
    }

    function setupCardInputs() {
      const num = document.getElementById('cc_number');
      const exp = document.getElementById('cc_exp');
      const cvv = document.getElementById('cc_cvv');
      if (!num || !exp || !cvv) return;

  // create brand indicator (icon only)
  let brandEl = document.createElement('div'); brandEl.className = 'card-brand'; brandEl.innerHTML = '<span class="logo" aria-hidden="true" tabindex="0" role="button" aria-label="Use saved card"></span>';
      num.parentNode && num.parentNode.classList && num.parentNode.classList.add('card-field');
      num.parentNode && num.parentNode.appendChild(brandEl);
      // move the shared saved-cards menu into this card-field so absolute positioning is correct
      const sharedMenu = document.getElementById('saved_cards_menu'); if (sharedMenu && num.parentNode) { try{ num.parentNode.appendChild(sharedMenu); }catch(e){} }

      num.addEventListener('input', (e) => {
        const before = num.selectionStart || num.value.length;
        const formatted = formatCardNumber(num.value);
        num.value = formatted;
  const brand = detectCardBrand(formatted);
  const logo = brand ? brand.logo : '';
  // set the logo only (no textual name)
  brandEl.querySelector('.logo').style.backgroundImage = logo || 'none';
        // attach click handler to logo to open browser saved-card prompt or fallback to menu
        const logoEl = brandEl.querySelector('.logo');
        if (logoEl) {
          logoEl.onclick = async (ev) => { ev.stopPropagation(); const ok = await askBrowserForCard().catch(()=>false); if (!ok) toggleSavedCardsMenu(); };
          logoEl.addEventListener('keydown', async (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); const ok = await askBrowserForCard().catch(()=>false); if (!ok) toggleSavedCardsMenu(); } });
        }
        // inline hint color for invalid Luhn
        if (formatted.replace(/\s+/g,'').length >= 12) {
          if (!luhnCheck(formatted)) num.style.borderColor = '#ff6b6b'; else num.style.borderColor = '';
        } else { num.style.borderColor = ''; }
      });

      exp.addEventListener('input', (e) => {
        let v = exp.value.replace(/\D/g,'').slice(0,4);
        if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
        exp.value = v;
      });

      cvv.addEventListener('input', (e) => {
        cvv.value = cvv.value.replace(/\D/g,'').slice(0,4);
      });
      // Render saved cards count
      renderSavedCardsCount();
      // click outside to close saved cards menu
      document.addEventListener('click', (e) => { const m = document.getElementById('saved_cards_menu'); if (m && m.classList.contains('visible')) m.classList.remove('visible'); });
    }

    // Saved cards helpers (localStorage-backed, opt-in)
    function getSavedCards(){ try { return JSON.parse(localStorage.getItem('saved_cards')||'[]'); } catch(_){ return []; } }
    function saveCardLocally(card){ try{ const list = getSavedCards(); // keep only last 6
      list.unshift(card); while(list.length>6) list.pop(); localStorage.setItem('saved_cards', JSON.stringify(list)); renderSavedCardsCount(); }catch(e){console.warn('saveCardLocally failed',e);} }
    function renderSavedCardsCount(){ const c = getSavedCards().length; const el = document.getElementById('saved_cards_count'); if (el) el.textContent = String(c); }
    function renderSavedCardsMenu(){ const menu = document.getElementById('saved_cards_menu'); if (!menu) return; const list = getSavedCards(); menu.innerHTML = ''; if (!list.length) { menu.innerHTML = '<div style="padding:8px;color:#6b7280">No saved cards</div>'; return; }
      list.forEach((c, idx) => {
        const row = document.createElement('div'); row.className='card-row';
        const thumb = document.createElement('div'); thumb.className='card-thumb'; thumb.style.backgroundImage = c.logo || '';
        const meta = document.createElement('div'); meta.className='card-meta'; meta.innerHTML = `<div style="font-weight:700">${escapeHtml(c.name||'')}</div><div style="color:#6b7280">**** **** **** ${String(c.last4)}</div>`;
        const actions = document.createElement('div'); actions.className='card-actions'; actions.innerHTML = '<span class="use">Use</span> &nbsp; <span class="del" style="color:#c44;cursor:pointer">Remove</span>';
        row.appendChild(thumb); row.appendChild(meta); row.appendChild(actions);
        row.querySelector('.use').addEventListener('click', (ev)=>{ ev.stopPropagation(); fillCardFromSaved(c); menu.classList.remove('visible'); });
        row.querySelector('.del').addEventListener('click', (ev)=>{ ev.stopPropagation(); removeSavedCard(idx); renderSavedCardsMenu(); renderSavedCardsCount(); });
        menu.appendChild(row);
      });
    }

    function removeSavedCard(index){ try{ const list = getSavedCards(); if (index<0||index>=list.length) return; list.splice(index,1); localStorage.setItem('saved_cards', JSON.stringify(list)); }catch(e){console.warn('removeSavedCard failed',e);} }
    function toggleSavedCardsMenu(){ const menu = document.getElementById('saved_cards_menu'); if (!menu) return; renderSavedCardsMenu(); menu.classList.toggle('visible'); }
    function fillCardFromSaved(c){ try{ if (!c) return; document.getElementById('cc_name').value = c.name || ''; document.getElementById('cc_number').value = '**** **** **** ' + (c.last4 || ''); document.getElementById('cc_exp').value = c.exp || ''; // do not fill cvv
      // focus CVV for user to enter
      try{ document.getElementById('cc_cvv').focus(); }catch(_){ }
      // show brand logo
      const brand = detectCardBrand(c.last4 || ''); const logo = brand ? brand.logo : (c.logo||''); const brandEl = document.querySelector('.card-brand .logo'); if (brandEl) brandEl.style.backgroundImage = logo || 'none';
    }catch(e){console.warn('fillCardFromSaved failed', e);} }

    // Payment Request API: prompt browser to provide saved card details (if available)
    async function askBrowserForCard(){
      if (!window.PaymentRequest) return false;
      try{
        const supportedInstruments = [{ supportedMethods: 'basic-card' }];
        const details = { total: { label: 'Test Authorization', amount: { currency: 'USD', value: '0.00' } } };
        const request = new PaymentRequest(supportedInstruments, details, { requestPayerName: true });
        // show will prompt available payment instruments (cards saved in browser)
        const resp = await request.show();
        // resp.details may contain card info when using basic-card
        try{ const d = resp.details || {}; if (d.cardNumber || d.cardholderName) {
            // fill known fields
            if (d.cardholderName) document.getElementById('cc_name').value = d.cardholderName;
            if (d.cardNumber) document.getElementById('cc_number').value = formatCardNumber(String(d.cardNumber));
            if (d.expiryMonth && d.expiryYear) document.getElementById('cc_exp').value = String(d.expiryMonth).padStart(2,'0') + '/' + String(d.expiryYear).slice(-2);
          }
        }catch(e){ console.warn('PaymentRequest details parsing failed', e); }
        try{ await resp.complete('success'); }catch(e){}
        return true;
      }catch(e){ console.warn('PaymentRequest failed or cancelled', e); return false; }
    }

    document.addEventListener('DOMContentLoaded', () => { setupCardInputs(); });

    // Load card gateway config and initialize Stripe Elements if configured
    let stripe = null; let stripeElements = null; let stripeCardElement = null; let cardProvider = '';
    async function initCardGateway() {
      try {
        const cfg = await fetch(backendBase + '/config/card').then(r => r.json()).catch(()=>null);
        if (!cfg || !cfg.provider) return;
        cardProvider = String(cfg.provider || '').toLowerCase();
        if (cardProvider === 'stripe' && cfg.publishableKey) {
          // load Stripe.js
          if (!window.Stripe) {
            const s = document.createElement('script');
            s.src = 'https://js.stripe.com/v3/'; s.async = true; document.head.appendChild(s);
            await new Promise((res, rej) => { s.onload = res; s.onerror = rej; });
          }
          stripe = window.Stripe(cfg.publishableKey);
          stripeElements = stripe.elements();
          // Create a card Element and mount it into a new container if present
          const cardContainer = document.createElement('div'); cardContainer.id = 'stripe-card-element'; cardContainer.style.marginTop = '8px';
          const payCard = document.getElementById('payCard'); if (payCard) {
            // insert the stripe card element at the top of payCard and hide native inputs
            payCard.insertBefore(cardContainer, payCard.firstChild);
            const nativeFields = ['cc_name','cc_number','cc_exp','cc_cvv']; nativeFields.forEach(id=>{ const e = document.getElementById(id); if (e) e.style.display = 'none'; });
            stripeCardElement = stripeElements.create('card', { hidePostalCode: true, style: {
              base: { color: '#111827', fontFamily: 'Montserrat, Roboto, Arial, sans-serif', fontSize: '16px', '::placeholder': { color: '#9aa0a6' } },
              invalid: { color: '#ff4444' }
            } });
            stripeCardElement.mount('#stripe-card-element');
          }
        }
      } catch (e) { console.warn('initCardGateway failed', e); }
    }
    initCardGateway();

    function loadOrder() {
      try {
        const stored = JSON.parse(localStorage.getItem('orderDetails') || '[]');
        orderItems = Array.isArray(stored) ? stored : [];
      } catch (_) { orderItems = []; }
      document.getElementById('orderWrap').style.display = orderItems.length ? '' : 'none';
      document.getElementById('emptyState').style.display = orderItems.length ? 'none' : '';
    }

    function renderItems() {
      const root = document.getElementById('items');
      root.innerHTML = '';
      orderItems.forEach((p, idx) => {
        const img = p.mainImage || p.img || (Array.isArray(p.galleryImages) && p.galleryImages[0]) || '';
        const thumbs = Array.isArray(p.galleryImages) ? p.galleryImages.slice(0,6) : [];
        const details = p.details || {};
        const q = p.quantity && p.quantity > 0 ? p.quantity : 1;
        // Use sale price when active, but keep original price for strike-through
  // Allow sale.price provided as string by some pages; coerce to Number
  const isOnSale = p && p.sale && p.sale.active && Number(p.sale.price) > 0;
  const unitPrice = isOnSale ? Number(p.sale.price) : Number(p.price || 0);
        const origUnitPrice = Number(p.price || 0);
        const longDesc = (p.desc || '').length > 140;
        const el = document.createElement('div');
        el.className = 'item';
        // Price HTML: show struck original price and sale badge when on sale
        const priceHtml = isOnSale
          ? `<div class="item-price"><span style="text-decoration:line-through;opacity:0.8;margin-right:0.5rem">${format(origUnitPrice)}</span><span style="background:#ffffff;padding:0.18rem 0.5rem;color:#000;border-radius:0.45rem;font-weight:700">${format(unitPrice)}</span></div>`
          : `<div class="item-price">${format(unitPrice * q)}</div>`;

        el.innerHTML = `
          <button class="item-remove" title="Remove" onclick="event.stopPropagation(); removeOrderItem(${idx})">&times;</button>
          ${img ? `<img class="main" src="${img}" alt="${p.title||p.name||'Product'}" loading="lazy" decoding="async">` : '<div></div>'}
          <div>
            <div class="item-title">${p.title || p.name || 'Untitled'} ${
              p.album ? (() => {
                // Normalize album URL to include .html when appropriate and avoid overwriting existing query params
                let albumRaw = String(p.album || '');
                // If it's not an absolute URL and doesn't already look like a .html file, append .html
                if (!/^(https?:)?\/\//i.test(albumRaw) && !/\.html(?:$|[?#])/i.test(albumRaw)) {
                  albumRaw = albumRaw.endsWith('/') ? (albumRaw + 'index.html') : (albumRaw + '.html');
                }
                const href = albumRaw + (albumRaw.includes('?') ? '&' : '?') + 'from=order';
                // Open in same tab so history back goes to order page, and ensure from=order is preserved
                return `<span class="item-meta">&nbsp;· <a href="${href}" style="color:#89b4ff;">View</a></span>`;
              })() : ''
            }</div>
            ${p.desc ? ('<div class="item-desc" id="desc-'+idx+'">'+(p.desc||'')+'</div>') : ''}
            ${p.desc && longDesc ? ('<button class="show-more-btn" onclick="toggleDesc('+idx+')">Read more</button>') : ''}
            ${(details.blade||details.handle||details.length||details.weight||details.features) ? `
              <div class="item-details">
                ${details.blade ? `<div><b>Blade:</b> ${details.blade}</div>`:''}
                ${details.handle ? `<div><b>Handle:</b> ${details.handle}</div>`:''}
                ${details.length ? `<div><b>Length:</b> ${details.length}</div>`:''}
                ${details.weight ? `<div><b>Weight:</b> ${details.weight}</div>`:''}
                ${details.features ? `<div><b>Features:</b> ${details.features}</div>`:''}
              </div>` : ''}
            ${thumbs.length ? `<div class="thumbs">${thumbs.map(t=>`<img src="${t}" alt="thumbnail" loading="lazy" decoding="async">`).join('')}</div>`: ''}
            <div class="item-meta">Quantity: <b>${q}</b></div>
          </div>
          ${priceHtml}
        `;
        root.appendChild(el);
      });
    }

    function computeTotals() {
      const subtotal = orderItems.reduce((sum, p) => {
        const q = p.quantity && p.quantity>0 ? p.quantity : 1;
  const unit = (p && p.sale && p.sale.active && Number(p.sale.price) > 0) ? Number(p.sale.price) : Number(p.price||0);
        return sum + unit * q;
      }, 0);
      const shipping = 0; // Flat/free shipping demo
      const tax = 0;      // No tax demo
      const total = subtotal + shipping + tax;
      return { subtotal, shipping, tax, total };
    }
  function renderTotals() {
      const t = computeTotals();
      const root = document.getElementById('totals');
      root.innerHTML = '';
      const rows = [
        ['Subtotal', format(t.subtotal)],
    ['Shipping', shippingLabel(t.shipping)],
    ['Tax', format(t.tax)],
      ];
      rows.forEach(([label, val]) => {
        const r = document.createElement('div'); r.className = 'totals-row';
        r.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        root.appendChild(r);
      });
      const tr = document.createElement('div'); tr.className = 'totals-row total';
      tr.innerHTML = `<div class="label">Total</div><div class="value" id="grandTotal">${format(t.total)}</div>`;
      root.appendChild(tr);
    }

    function shippingLabel(s) { return s === 0 ? 'Free' : format(s); }

    function togglePay(which) {
      document.getElementById('payCard').style.display = which === 'card' ? '' : 'none';
      document.getElementById('payPaypal').style.display = which === 'paypal' ? '' : 'none';
      if (which === 'paypal' && !paypalLoaded) {
        ensurePayPalButtons();
      }
    }

    function toggleDesc(i) {
      const el = document.getElementById('desc-' + i);
      if (!el) return;
      el.classList.toggle('expanded');
      // Switch button label
      const btn = el.nextElementSibling;
      if (btn && btn.classList.contains('show-more-btn')) {
        btn.textContent = el.classList.contains('expanded') ? 'Show less' : 'Read more';
      }
    }

    function getShippingData() {
      return {
        name: document.getElementById('ship_name').value.trim(),
        email: document.getElementById('ship_email').value.trim(),
        phone: document.getElementById('ship_phone').value.trim(),
        country: document.getElementById('ship_country').value.trim(),
        city: document.getElementById('ship_city').value.trim(),
        state: document.getElementById('ship_state').value.trim(),
        zip: document.getElementById('ship_zip').value.trim(),
        address: document.getElementById('ship_address').value.trim(),
      };
    }

    function saveShippingData() {
      try { localStorage.setItem('shippingInfo', JSON.stringify(getShippingData())); } catch (_) {}
    }

    function loadShippingData() {
      try {
        const s = JSON.parse(localStorage.getItem('shippingInfo')||'null');
        if (!s) return;
        if (s.name) document.getElementById('ship_name').value = s.name;
        if (s.email) document.getElementById('ship_email').value = s.email;
        if (s.phone) document.getElementById('ship_phone').value = s.phone;
        if (s.country) document.getElementById('ship_country').value = s.country;
        if (s.city) document.getElementById('ship_city').value = s.city;
        if (s.state) document.getElementById('ship_state').value = s.state;
        if (s.zip) document.getElementById('ship_zip').value = s.zip;
        if (s.address) document.getElementById('ship_address').value = s.address;
      } catch(_) {}
    }

    function validateShipping() {
      const req = ['ship_name','ship_email','ship_phone','ship_country','ship_city','ship_state','ship_zip','ship_address'];
      for (const id of req) { if (!document.getElementById(id).value.trim()) return false; }
      return true;
    }

  async function payWithCard() {
      const msg = document.getElementById('cardMsg');
      const cardNotice = document.getElementById('cardNotice');
      if (msg) { msg.textContent = ''; msg.className = 'notice'; }
      if (!validateShipping()) { if (msg) { msg.textContent = 'Please fill shipping details.'; msg.className = 'notice err'; } return; }
      const cc_name = document.getElementById('cc_name').value.trim();
      const cc_number = document.getElementById('cc_number').value.trim();
      const cc_exp = document.getElementById('cc_exp').value.trim();
      const cc_cvv = document.getElementById('cc_cvv').value.trim();
      // prepare a minimal saved-card object (do NOT store PAN/CVV) if user opts-in after success
      const detectedBrand = detectCardBrand(cc_number);
      const tempSavedCard = {
        name: cc_name || '',
        last4: (cc_number.replace(/\D/g,'')).slice(-4),
        exp: cc_exp || '',
        logo: detectedBrand ? detectedBrand.logo : ''
      };
      if (!cc_name || !cc_number || !cc_exp || !cc_cvv) { if (msg) { msg.textContent = 'Please fill all card fields.'; msg.className = 'notice err'; } return; }
      saveShippingData();

      // Prepare payload
      const items = orderItems.map(p => ({ title: p.title||p.name||'Item', price: Number((p.sale && p.sale.active && Number(p.sale.price)>0) ? p.sale.price : p.price) || 0, quantity: (p.quantity && p.quantity>0)? p.quantity:1 }));
      const shipping = getShippingData();
      const total = computeTotals().total;

      const payBtn = document.querySelector('.pay-submit .btn');
      if (payBtn) { payBtn.disabled = true; payBtn.dataset.orig = payBtn.textContent; payBtn.textContent = 'Processing...'; }
      if (cardNotice) { cardNotice.textContent = 'Processing payment...'; }

      // If Stripe Elements is available and configured, use PaymentIntent flow
      if (cardProvider === 'stripe' && stripe && stripeCardElement) {
        try {
          // Create PaymentIntent on server
          const resp = await fetch(backendBase + '/api/payments/stripe/create-payment-intent', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount: total, currency: currency.toLowerCase(), items }) });
          if (!resp.ok) {
            const txt = await resp.text().catch(()=>null);
            if (msg) { msg.textContent = 'Failed to create payment intent: ' + (txt||resp.status); msg.className = 'notice err'; }
            return;
          }
          const data = await resp.json();
          if (!data || !data.clientSecret) { if (msg) { msg.textContent = 'Payment intent creation returned unexpected response.'; msg.className = 'notice err'; } return; }
          // Confirm card payment using Elements
          const confirmResult = await stripe.confirmCardPayment(data.clientSecret, { payment_method: { card: stripeCardElement, billing_details: { name: cc_name } } });
          if (confirmResult.error) {
            if (msg) { msg.textContent = confirmResult.error.message || 'Payment failed'; msg.className = 'notice err'; }
            return;
          }
          if (confirmResult.paymentIntent && confirmResult.paymentIntent.status === 'succeeded') {
            try{ const saveOpt = document.getElementById('save_card_opt'); if (saveOpt && saveOpt.checked) saveCardLocally(tempSavedCard); }catch(_){ }
            onPaymentSuccess({ method: 'card', id: confirmResult.paymentIntent.id });
            return;
          }
          if (msg) { msg.textContent = 'Payment did not complete.'; msg.className = 'notice err'; }
        } catch (e) {
          console.error('Stripe payment failed', e);
          if (msg) { msg.textContent = 'Stripe payment failed. ' + (e && e.message || ''); msg.className = 'notice err'; }
        } finally {
          if (payBtn) { payBtn.disabled = false; payBtn.textContent = payBtn.dataset.orig || 'Pay now'; }
          if (cardNotice) { cardNotice.textContent = 'Secure payment — processed by the configured gateway.'; }
        }
        return;
      }

      // Fallback: POST to server; server should process via configured gateway and return { success:true, id: 'txn_...' }
      fetch(backendBase + '/api/payments/card', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, shipping, amount: total, card: { name: cc_name, number: cc_number, exp: cc_exp, cvv: cc_cvv } })
      }).then(async resp => {
        if (!resp.ok) {
          if (resp.status === 404) {
            // Endpoint missing on server
            if (msg) { msg.textContent = 'Card payment endpoint not available on server. Please configure card gateway in admin.'; msg.className = 'notice err'; }
            return;
          }
          const text = await resp.text().catch(()=>null);
          if (msg) { msg.textContent = (text && text.length<1000) ? text : 'Payment failed. Server returned ' + resp.status; msg.className = 'notice err'; }
          return;
        }
        const data = await resp.json().catch(()=>null);
        if (data && data.success) {
          // Optionally save minimal card metadata (last4, name, exp) locally if user opted in
          try{ const saveOpt = document.getElementById('save_card_opt'); if (saveOpt && saveOpt.checked) saveCardLocally(tempSavedCard); }catch(_){ }
          // Show success and pass transaction id to success handler
          onPaymentSuccess({ method: 'card', id: data.id || data.tx || ('CARD-' + Date.now()) });
        } else if (data && data.error) {
          if (msg) { msg.textContent = data.error; msg.className = 'notice err'; }
        } else {
            if (data && (data.id || data.tx)) {
              try{ const saveOpt = document.getElementById('save_card_opt'); if (saveOpt && saveOpt.checked) saveCardLocally(tempSavedCard); }catch(_){ }
            onPaymentSuccess({ method: 'card', id: data.id || data.tx });
          } else {
            if (msg) { msg.textContent = 'Payment response was unexpected.'; msg.className = 'notice err'; }
          }
        }
      }).catch(err => {
        console.error(err);
        if (msg) { msg.textContent = 'Network error. Could not reach payment server.'; msg.className = 'notice err'; }
      }).finally(()=>{
        if (payBtn) { payBtn.disabled = false; payBtn.textContent = payBtn.dataset.orig || 'Pay now'; }
        if (cardNotice) { cardNotice.textContent = 'Secure payment — processed by the configured gateway.'; }
      });
    }

    function removeOrderItem(i) {
      if (i < 0 || i >= orderItems.length) return;
      orderItems.splice(i, 1);
      if (orderItems.length) {
        localStorage.setItem('orderDetails', JSON.stringify(orderItems));
        renderItems();
        renderTotals();
      } else {
        localStorage.removeItem('orderDetails');
        document.getElementById('orderWrap').style.display = 'none';
        document.getElementById('emptyState').style.display = '';
      }
    }

    function onPaymentSuccess(info) {
      // Persist order record (optional): in demo we just clear and show success
      localStorage.removeItem('orderDetails');
      const wrap = document.getElementById('orderWrap');
      wrap.innerHTML = `<div class="card" style="text-align:center;">
        <h2 class="ok">Payment successful</h2>
        <div class="notice">Thank you. Your payment (${info.method}) was confirmed.</div>
        <div style="margin-top:0.8rem;">
          <a class="btn" href="index.html">Back to Home</a>
        </div>
      </div>`;
    }

    // Load PayPal SDK dynamically so we can pass total amount after render
    function ensurePayPalButtons() {
      const container = document.getElementById('paypal-button-container');
      if (!container) return;
      if (paypalLoaded) { renderPayPal(); return; }
      // Load PayPal SDK with live client-id from backend
      fetch(backendBase + '/config/paypal').then(r => r.json()).then(cfg => {
        if (!cfg.clientId) { alert('PayPal not configured on server.'); return; }
        const script = document.createElement('script');
        script.src = 'https://www.paypal.com/sdk/js?client-id=' + encodeURIComponent(cfg.clientId) + '&currency=' + (cfg.currency||'USD') + '&intent=' + (cfg.intent||'CAPTURE');
        script.onload = renderPayPal;
        document.body.appendChild(script);
      }).catch(() => alert('Failed to load PayPal config.'));
    }

    function renderPayPal() {
      if (!window.paypal) return;
      paypalLoaded = true;
      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
        createOrder: async () => {
          if (!validateShipping()) { alert('Please fill shipping details first.'); return; }
          saveShippingData();
          const t = computeTotals();
          const shipping = getShippingData();
          const items = orderItems.map(p => ({ title: p.title||p.name||'Item', price: Number(p.price)||0, quantity: (p.quantity && p.quantity>0)? p.quantity:1 }));
          const resp = await fetch(backendBase + '/api/orders', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items, shipping })
          });
          if (!resp.ok) { const txt = await resp.text(); throw new Error(txt||'Order creation failed'); }
          const data = await resp.json();
          return data.id;
        },
        onApprove: async (data) => {
          const resp = await fetch(backendBase + '/api/orders/' + encodeURIComponent(data.orderID) + '/capture', { method: 'POST' });
          if (!resp.ok) { const txt = await resp.text(); throw new Error(txt||'Capture failed'); }
          const details = await resp.json();
          onPaymentSuccess({ method: 'paypal', id: details?.id || data.orderID });
        },
        onError: (err) => { console.error(err); alert('PayPal error. Please try another method.'); }
      }).render('#paypal-button-container');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadOrder();
      if (!orderItems.length) return; // nothing to do
      loadShippingData();
      renderItems();
      renderTotals();
      // Defer PayPal SDK until user selects PayPal
    });
  </script>
</body>
</html>
