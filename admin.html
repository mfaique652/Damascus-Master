<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Login - Damascus Master</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="theme.css">
  <style>
    :root{
      --bg-1:#071029; --bg-2:#08223a; --card:#0f1726; --accent:#f2c94c; --btn:#2563eb; --muted:#9aa7b3;
      --radius:14px; --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:#fff;display:flex;align-items:center;justify-content:center;margin:0;padding:24px}
    .login-wrap{max-width:980px;width:100%;display:flex;gap:28px;align-items:center;justify-content:center}
    .brand{flex:0 0 340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:28px;border-radius:var(--radius);box-shadow:0 12px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .brand h2{margin:0;color:var(--accent);letter-spacing:0.02em}
    .brand p{color:var(--muted);margin-top:8px}
    .login-card{background:var(--card);padding:28px;border-radius:var(--radius);width:420px;box-shadow:0 20px 50px rgba(2,6,23,0.6);border:1px solid var(--glass)}
    .login-card h1{margin:0 0 10px;font-size:20px}
    .login-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{margin:10px 0}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--btn),#1e40af);color:#fff;cursor:pointer;font-weight:700}
    .secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 12px;border-radius:10px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="login-wrap">
    <div class="brand">
      <h2>Damascus Master</h2>
      <p class="muted">Admin Control Center ‚Äî secure access only.</p>
      <div style="margin-top:18px;font-size:13px;color:var(--muted)">Quick links</div>
      <div id="admin-quick-links" style="display:none;gap:8px;margin-top:10px">
        <button class="secondary" onclick="location.href='admin-dashboard.html'">Dashboard</button>
        <button class="secondary" onclick="location.href='visual-editor.html'">Editor</button>
        <button class="secondary" onclick="location.href='payment-gateway.html'">Gateway</button>
      </div>
    </div>

    <div class="login-card" role="main" aria-labelledby="login-title">
      <h1 id="login-title">Sign in to Admin</h1>
      <div id="login-error" style="color:#ff8a8a;display:none;margin-bottom:8px"></div>
      <form onsubmit="login(event)">
        <div class="field">
          <label class="small" for="email">Email</label>
          <input id="email" type="email" placeholder="you@company.com" required />
        </div>
        <div class="field">
          <label class="small" for="password">Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>
        <div style="display:flex;gap:12px;margin-top:14px;align-items:center">
          <button class="btn" type="submit">üîê Sign In</button>
        </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="dev-refresh-btn" class="secondary" type="button" style="display:none">üîÅ Refresh Token</button>
            <span id="dev-refresh-msg" class="small" style="display:none;margin-left:8px;color:var(--muted)"></span>
          </div>
      </form>
      <div style="margin-top:14px" class="muted">After signing in you'll see options for Dashboard, Visual Editor and Gateway.</div>
    </div>
  </div>

  <script src="tools/admin-auth.js"></script>
  <script>
    // nicer login flow: use shared adminAuth and show chooser on success
    async function login(e){
      e && e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const err = document.getElementById('login-error'); err.style.display='none';
      try{
        let ok = false;
        if (window.adminAuth && typeof window.adminAuth.performLogin === 'function'){
          const res = await window.adminAuth.performLogin(email, password);
          ok = !!(res && res.ok);
        } else {
          const r = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
          ok = r.ok;
          if (ok) {
            const d = await r.json(); if (d && d.token) localStorage.setItem('adm_token', d.token);
          }
        }

        if (!ok) throw new Error('Invalid credentials');

        // If there's a redirect query param (e.g. ?redirect=payment-gateway) honor it
        const params = new URLSearchParams(window.location.search || '');
        const redirect = params.get('redirect');

        // If adminAuth has a chooser modal, use it; otherwise navigate directly
        // On success, reveal quick links and preview button (and honor redirect)
        try{ document.getElementById('admin-quick-links').style.display = 'flex'; }catch(_){ }
        try{ document.getElementById('preview-dashboard').style.display = ''; }catch(_){ }
        if (redirect) {
          // small delay to allow token verification
          setTimeout(()=> { window.location.href = redirect === 'dashboard' ? 'admin-dashboard.html' : (redirect === 'visual-editor' ? 'visual-editor.html' : (redirect === 'payment-gateway' ? 'payment-gateway.html' : 'admin-dashboard.html')); }, 200);
        } else {
          // show admin menu if available
          try{ if (window.adminAuth && typeof window.adminAuth.showAdminMenu === 'function') window.adminAuth.showAdminMenu(); }catch(_){ }
        }

      } catch (e){ err.textContent = e.message || 'Login failed'; err.style.display='block'; }
    }

    // If query param redirect exists and user already authenticated, navigate automatically
    document.addEventListener('DOMContentLoaded', async function(){
      const params = new URLSearchParams(window.location.search || '');
      const redirect = params.get('redirect');
      if (!redirect) return;
      try{
        if (window.adminAuth && typeof window.adminAuth.verifyAdminToken === 'function'){
          const prof = await window.adminAuth.verifyAdminToken();
          if (prof) {
            // already authenticated -> go to target
            if (redirect === 'dashboard') location.href = 'admin-dashboard.html';
            else if (redirect === 'visual-editor') location.href = 'visual-editor.html';
            else if (redirect === 'payment-gateway') location.href = 'payment-gateway.html';
          }
        }
      }catch(_){ /* ignore */ }
    });

    // Dev helper: Refresh token button (only shown in non-production)
    (function(){
      try{
        const show = String((window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || (location.search || '').indexOf('dev=true') !== -1)).toLowerCase() === 'true';
        const btn = document.getElementById('dev-refresh-btn');
        const msg = document.getElementById('dev-refresh-msg');
        if (!btn) return;
        if (!show) return;
        btn.style.display = '';
        btn.addEventListener('click', async function(){
          try{
            const old = localStorage.getItem('adm_token') || localStorage.getItem('authToken') || '';
            if (!old) { msg.textContent = 'no token in localStorage'; msg.style.display='inline'; return; }
            msg.textContent = 'Refreshing...'; msg.style.display='inline';
            const r = await fetch('/api/auth/refresh', { method: 'POST', headers: { 'Authorization': 'Bearer ' + old } });
            const j = await r.json();
            if (j && j.token) {
              localStorage.setItem('adm_token', j.token);
              localStorage.setItem('authToken', j.token);
              msg.textContent = 'Token refreshed';
              setTimeout(()=> msg.style.display='none', 3000);
            } else {
              msg.textContent = 'Refresh failed';
            }
          } catch (e) { msg.textContent = 'Refresh error'; }
        });
      }catch(e){ }
    })();
  </script>
</body>
</html>
