<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Login - Damascus Master</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="theme.css">
  <style>
    :root{
      --bg-1:#071029; --bg-2:#08223a; --card:#0f1726; --accent:#f2c94c; --btn:#2563eb; --muted:#9aa7b3;
      --radius:14px; --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:#fff;display:flex;align-items:center;justify-content:center;margin:0;padding:24px}
  .login-wrap{max-width:980px;width:100%;display:flex;gap:18px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
  /* Make brand flexible so the right-side card can shrink without causing horizontal scroll */
  .brand{flex:0 1 340px;min-width:160px;max-width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px 16px;border-radius:var(--radius);box-shadow:0 12px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .brand h2{margin:0;color:var(--accent);letter-spacing:0.02em}
    .brand p{color:var(--muted);margin-top:8px}
  /* Limit width on large screens but allow the card to shrink on smaller viewports */
  .login-card{background:var(--card);padding:18px;border-radius:var(--radius);max-width:340px;width:100%;box-shadow:0 20px 50px rgba(2,6,23,0.6);border:1px solid var(--glass);box-sizing:border-box}
  .login-card h1{margin:0 0 10px;font-size:20px;color:rgba(255,255,255,0.98);font-weight:700}
    .login-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{margin:10px 0}
  /* make inputs compact and constrain width inside the login card */
  input{width:100%;max-width:300px;margin:0;display:block;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:0.92rem;height:auto}
  .login-card .field{display:flex;justify-content:flex-start}
  .login-card .field input{margin:0}
  /* smaller, muted placeholders for admin inputs */
  input::placeholder{color:rgba(255,255,255,0.55);font-size:0.9rem}
  /* labels slightly smaller and muted to reduce visual weight */
  label.small{font-size:0.85rem;color:rgba(255,255,255,0.75)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--btn),#1e40af);color:#fff;cursor:pointer;font-weight:700}
    .secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 12px;border-radius:10px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}

    /* Responsive tweaks */
    @media (max-width: 900px) {
    body{padding:16px;align-items:flex-start}
  .login-wrap{flex-direction:column;align-items:stretch;gap:14px}
  /* stack the brand content vertically on smaller screens to avoid overflow */
  .brand{flex:none;width:100%;padding:12px;border-radius:12px;display:flex;flex-direction:column;align-items:flex-start;gap:8px}
      .brand h2{font-size:1.25rem}
      .brand p{margin:0;display:block}
      .login-card{width:100%;padding:18px;border-radius:12px}
      .login-row{grid-template-columns:1fr}
  .btn{width:100%;justify-content:center}
  #admin-quick-links{display:flex;flex-direction:row;flex-wrap:wrap;gap:8px}
  #admin-quick-links button.secondary{flex:1 1 auto;min-width:120px}
  input::placeholder{font-size:0.82rem}
  input{padding:6px 8px}
    }

    @media (max-width: 480px) {
    body{padding:12px;align-items:flex-start}
      .brand{padding:12px;gap:10px}
      .login-card{padding:14px}
      .login-card h1{font-size:1.05rem}
  input{padding:6px 8px}
  input::placeholder{font-size:0.78rem}
  /* On very small screens let inputs take full available width again */
  @media (max-width: 420px) {
    .login-card input{max-width:100%}
    .login-card .field{justify-content:stretch}
  }
  .btn{padding:10px;border-radius:8px}
  .brand h2{font-size:1.05rem}
  .login-wrap{gap:10px}
  #admin-quick-links button.secondary{width:100%;text-align:center}
    }
  </style>
</head>
<body>
  <div class="login-wrap">
    <div class="brand">
      <h2>Damascus Master</h2>
      <p class="muted">Admin Control Center ‚Äî secure access only.</p>
      <div style="margin-top:18px;font-size:13px;color:var(--muted)">Quick links</div>
      <div id="admin-quick-links" style="display:none;gap:8px;margin-top:10px">
        <button class="secondary" onclick="location.href='admin-dashboard.html'">Dashboard</button>
        <button class="secondary" onclick="location.href='visual-editor.html'">Editor</button>
        <button class="secondary" onclick="location.href='payment-gateway.html'">Gateway</button>
      </div>
    </div>

    <div class="login-card" role="main" aria-labelledby="login-title">
      <h1 id="login-title">Sign in to Admin</h1>
      <div id="login-error" style="color:#ff8a8a;display:none;margin-bottom:8px"></div>
      <form onsubmit="login(event)">
        <div class="field">
          <label class="small" for="email">Email</label>
          <input id="email" type="email" placeholder="you@company.com" required />
        </div>
        <div class="field">
          <label class="small" for="password">Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>
        <div style="display:flex;gap:12px;margin-top:14px;align-items:center">
          <button class="btn" type="submit">üîê Sign In</button>
        </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="dev-refresh-btn" class="secondary" type="button" style="display:none">üîÅ Refresh Token</button>
            <span id="dev-refresh-msg" class="small" style="display:none;margin-left:8px;color:var(--muted)"></span>
          </div>
      </form>
      <div style="margin-top:14px" class="muted">After signing in you'll see options for Dashboard, Visual Editor and Gateway.</div>
    </div>
  </div>

  <script src="tools/admin-auth.js"></script>
  <script>
    // nicer login flow: use shared adminAuth and show chooser on success
    async function login(e){
      e && e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const err = document.getElementById('login-error'); err.style.display='none';
      try{
        let ok = false;
        if (window.adminAuth && typeof window.adminAuth.performLogin === 'function'){
          const res = await window.adminAuth.performLogin(email, password);
          ok = !!(res && res.ok);
        } else {
          const r = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
          ok = r.ok;
          if (ok) {
            const d = await r.json(); if (d && d.token) localStorage.setItem('adm_token', d.token);
          }
        }

        if (!ok) throw new Error('Invalid credentials');

        // If there's a redirect query param (e.g. ?redirect=payment-gateway) honor it
        const params = new URLSearchParams(window.location.search || '');
        const redirect = params.get('redirect');

        // If adminAuth has a chooser modal, use it; otherwise navigate directly
        // On success, reveal quick links and preview button (and honor redirect)
        try{ document.getElementById('admin-quick-links').style.display = 'flex'; }catch(_){ }
        try{ document.getElementById('preview-dashboard').style.display = ''; }catch(_){ }
        if (redirect) {
          // small delay to allow token verification
          setTimeout(()=> { window.location.href = redirect === 'dashboard' ? 'admin-dashboard.html' : (redirect === 'visual-editor' ? 'visual-editor.html' : (redirect === 'payment-gateway' ? 'payment-gateway.html' : 'admin-dashboard.html')); }, 200);
        } else {
          // show admin menu if available
          try{ if (window.adminAuth && typeof window.adminAuth.showAdminMenu === 'function') window.adminAuth.showAdminMenu(); }catch(_){ }
        }

      } catch (e){ err.textContent = e.message || 'Login failed'; err.style.display='block'; }
    }

    // If query param redirect exists and user already authenticated, navigate automatically
    document.addEventListener('DOMContentLoaded', async function(){
      const params = new URLSearchParams(window.location.search || '');
      const redirect = params.get('redirect');
      if (!redirect) return;
      try{
        if (window.adminAuth && typeof window.adminAuth.verifyAdminToken === 'function'){
          const prof = await window.adminAuth.verifyAdminToken();
          if (prof) {
            // already authenticated -> go to target
            if (redirect === 'dashboard') location.href = 'admin-dashboard.html';
            else if (redirect === 'visual-editor') location.href = 'visual-editor.html';
            else if (redirect === 'payment-gateway') location.href = 'payment-gateway.html';
          }
        }
      }catch(_){ /* ignore */ }
    });

    // Dev helper: Refresh token button (only shown in non-production)
    (function(){
      try{
        const show = String((window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || (location.search || '').indexOf('dev=true') !== -1)).toLowerCase() === 'true';
        const btn = document.getElementById('dev-refresh-btn');
        const msg = document.getElementById('dev-refresh-msg');
        if (!btn) return;
        if (!show) return;
        btn.style.display = '';
        btn.addEventListener('click', async function(){
          try{
            const old = localStorage.getItem('adm_token') || localStorage.getItem('authToken') || '';
            if (!old) { msg.textContent = 'no token in localStorage'; msg.style.display='inline'; return; }
            msg.textContent = 'Refreshing...'; msg.style.display='inline';
            const r = await fetch('/api/auth/refresh', { method: 'POST', headers: { 'Authorization': 'Bearer ' + old } });
            const j = await r.json();
            if (j && j.token) {
              localStorage.setItem('adm_token', j.token);
              localStorage.setItem('authToken', j.token);
              msg.textContent = 'Token refreshed';
              setTimeout(()=> msg.style.display='none', 3000);
            } else {
              msg.textContent = 'Refresh failed';
            }
          } catch (e) { msg.textContent = 'Refresh error'; }
        });
      }catch(e){ }
    })();
  </script>
</body>
</html>
